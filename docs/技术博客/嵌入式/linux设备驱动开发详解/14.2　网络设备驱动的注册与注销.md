网络设备驱动的注册与注销由register_netdev（）和unregister_netdev（）函数完成，这两个函数的原型为：

```
int register_netdev(struct net_device *dev);
void unregister_netdev(struct net_device *dev);
```

这两个函数都接收一个net_device结构体指针为参数，可见net_device数据结构在网络设备驱动中的核心地位。

net_device的生成和成员的赋值并不一定要由工程师亲自动手逐个完成，可以利用下面的宏帮助我们填充：

```
#define alloc_netdev(sizeof_priv, name, setup) \
         alloc_netdev_mqs(sizeof_priv, name, setup, 1, 1)
#define alloc_etherdev(sizeof_priv) alloc_etherdev_mq(sizeof_priv, 1)
#define alloc_etherdev_mq(sizeof_priv, count) alloc_etherdev_mqs(sizeof_priv,
    count, count)
```

alloc_netdev以及alloc_etherdev宏引用的alloc_netdev_mqs（）函数的原型为：

```
struct net_device *alloc_netdev_mqs(int sizeof_priv, const char *name,
                void (*setup)(struct net_device *),
                unsigned int txqs, unsigned int rxqs);
```

alloc_netdev_mqs（）函数生成一个net_device结构体，对其成员赋值并返回该结构体的指针。第一个参数为设备私有成员的大小，第二个参数为设备名，第三个参数为net_device的setup（）函数指针，第四、五个参数为要分配的发送和接收子队列的数量。setup（）函数接收的参数也为struct net_device指针，用于预置net_device成员的值。

free_netdev（）完成与alloc_enetdev（）和alloc_etherdev（）函数相反的功能，即释放net_device结构体的函数：

```
void free_netdev(struct net_device *dev);
```

net_device结构体的分配和网络设备驱动的注册需在网络设备驱动程序初始化时进行，而net_device结构体的释放和网络设备驱动的注销在设备或驱动被移除的时候执行，如代码清单14.4所示。

代码清单14.4　网络设备驱动程序的注册和注销

```
 1static int xxx_register(void)
 2{
 3  ...
 4  /* 分配net_device结构体并对其成员赋值
 */
 5  xxx_dev = alloc_netdev(sizeof(struct xxx_priv), "sn%d", xxx_init);
 6  if (xxx_dev == NULL)
 7  ... /* 分配net_device失败*/
 8
 9  /* 注册net_device结构体 */
10    if ((result = register_netdev(xxx_dev)))
11    ...
12}
13
14static void xxx_unregister(void)
15{
16  ...
17  /* 注销net_device结构体*/
18  unregister_netdev(xxx_dev);
19  /* 释放net_device结构体*/
20  free_netdev(xxx_dev);
21}
```

