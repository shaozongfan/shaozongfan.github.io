USB OTG标准在完全兼容USB 2.0标准的基础上，它允许设备既可作为主机，也可作为外设操作，OTG新增了主机通令协议（HNP）和对话请求协议（SRP）。

在OTG中，初始主机设备称为A设备，外设称为B设备。可用电缆的连接方式来决定初始角色。两用设备使用新型Mini-AB插座，从而使Mini-A插头、Mini-B插头和Mini-AB插座增添了第5个引脚（ID），以用于识别不同的电缆端点。Mini-A插头中的ID引脚接地，Mini-B插头中的ID引脚浮空。当OTG设备检测到接地的ID引脚时，表示默认的是A设备（主机），而检测到ID引脚浮空的设备则认为是B设备（外设）。系统一旦连接后，OTG的角色还可以更换，以采用新的HNP协议。而SRP允许B设备请求A设备打开VBUS电源并启动一次对话。一次OTG对话可通过A设备提供VBUS电源的时间来确

自Linux 2.6.9开始，OTG相关源代码已经被包含在内核中了，新增的主要内容包括：

# （1）UDC驱动端添加的OTG相关属性和函数

```
struct usb_gadget {
    ...
    unsigned            is_otg:1;
    unsigned            is_a_peripheral:1;
    unsigned            b_hnp_enable:1;
    unsigned            a_hnp_support:1;
    unsigned            a_alt_hnp_support:1;
    ...
};
int usb_gadget_vbus_connect(struct usb_gadget *gadget);
int usb_gadget_vbus_disconnect(struct usb_gadget *gadget);
int usb_gadget_vbus_draw(struct usb_gadget *gadget, unsigned mA);
/* 控制USB D+的上拉*/
int usb_gadget_connect(struct usb_gadget *gadget);
int usb_gadget_disconnect(struct usb_gadget *gadget);
/* 尝试唤醒USB host，它也会尝试SRP会话*/
int usb_gadget_wakeup(struct usb_gadget *gadget);
```

# （2）Gadget驱动端添加的OTG相关属性和函数

如果gadget->is_otg字段为真，则增加一个OTG描述符；通过printk（）、LED等方式报告HNP可用；当挂起开始时，通过用户界面报告HNP切换开始（B-Peripheral到B-Host或A-Peripheral到A-Host）。

# （3）主机侧添加的OTG相关属性和函数

在USB核心中新增了关于OTG设备枚举的信息：

```
struct usb_bus {
    ...
    u8 otg_port;               /* 0, or index of OTG/HNP port */
    unsigned is_b_host:1;      /* true during some HNP roleswitches */
    unsigned b_hnp_enable:1;   /* OTG: did A-Host enable HNP  */
    ...
};
```

为了实现HNP需要的挂起/恢复，新增如下通用接口：

```
int usb_suspend_device(struct usb_device *dev, u32 state);
int usb_resume_device(struct usb_device *dev);
```

# （4）新增OTG功能切换和协议的描述结构体usb_otg

```
struct usb_otg {
       u8                   default_a;
       struct phy            *phy;
       /* old usb_phy interface */
       struct usb_phy        *usb_phy;
       struct usb_bus        *host;
       struct usb_gadget     *gadget;
       enum usb_otg_state    state;
       /* bind/unbind the host controller */
       int    (*set_host)(struct usb_otg *otg, struct usb_bus *host);
       /* bind/unbind the peripheral controller */
       int    (*set_peripheral)(struct usb_otg *otg,
                                 struct usb_gadget *gadget);
       /* effective for A-peripheral, ignored for B devices */
       int    (*set_vbus)(struct usb_otg *otg, bool enabled);
       /* for B devices only:  start session with A-Host */
       int    (*start_srp)(struct usb_otg *otg);
       /* start or continue HNP role switch */
       int    (*start_hnp)(struct usb_otg *otg);
};
```

usb_otg的代码一般在USB的phy端实现，目前，从内核的drivers/usb/musb/musb_gadget.c、drivers/usb/phy/phy-twl6030-usb.c、drivers/usb/phy/phy-isp1301-omap.c、drivers/usb/phy/phy-fsl-usb.c和drivers/usb/musb/musb_gadget.c等驱动中可以找到类似的例子。