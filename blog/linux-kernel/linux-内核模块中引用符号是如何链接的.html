<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="蒲城小农的文字世界 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="蒲城小农的文字世界 Atom Feed"><title data-rh="true">linux-kernel/linux-内核模块中引用符号是如何链接的 | 蒲城小农的文字世界</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://shaozongfan.github.io/blog/linux-kernel/linux-内核模块中引用符号是如何链接的"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="linux-kernel/linux-内核模块中引用符号是如何链接的 | 蒲城小农的文字世界"><meta data-rh="true" name="description" content="前言"><meta data-rh="true" property="og:description" content="前言"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2025-09-07T11:29:47.997Z"><link data-rh="true" rel="canonical" href="https://shaozongfan.github.io/blog/linux-kernel/linux-内核模块中引用符号是如何链接的"><link data-rh="true" rel="alternate" href="https://shaozongfan.github.io/blog/linux-kernel/linux-内核模块中引用符号是如何链接的" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://shaozongfan.github.io/blog/linux-kernel/linux-内核模块中引用符号是如何链接的" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.ccca8cd0.css">
<link rel="preload" href="/assets/js/runtime~main.b78e153e.js" as="script">
<link rel="preload" href="/assets/js/main.8780ac4d.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">蒲城小农的文字世界</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/shaozongfan" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">历史发布</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/libc/使用mtrace跟踪内存泄露问题">libc/使用mtrace跟踪内存泄露问题</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/linux-kernel/linux-内核模块中引用符号是如何链接的">linux-kernel/linux-内核模块中引用符号是如何链接的</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/welcome">Welcome</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/mdx-blog-post">MDX Blog Post</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/shaozongfan-blog-post">shaozongfan Blog Post</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/first-blog-post">First Blog Post</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_Ikge" itemprop="headline">linux-kernel/linux-内核模块中引用符号是如何链接的</h1><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2025-09-07T11:29:47.997Z" itemprop="datePublished">2025年9月7日</time> · <!-- -->11 分钟阅读</div></header><div id="post-content" class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a class="hash-link" href="#前言" title="标题的直接链接">​</a></h2><p>linux 内核模块的加载流程去年大致琢磨了一遍，简单的写了个草稿后就在草稿箱里积压着。按照以往的风格，应当以一篇长文呈现，今天想想却觉得不太可取。为什么不从关键的问题着手，使用较短的篇幅来逐个击破呢？</p><p>最终选择了从问题出发的描述方式，在这种方式下，我首先得提出关键问题，这需要一定的训练，本文便是这样的一次实践。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="我的问题">我的问题<a class="hash-link" href="#我的问题" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-linux-内核模块是如何链接的">1. <strong>linux 内核模块是如何链接的？</strong><a class="hash-link" href="#1-linux-内核模块是如何链接的" title="标题的直接链接">​</a></h3><p>暂时无法回答。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-为什么要提这个问题">2. 为什么要提这个问题？<a class="hash-link" href="#2-为什么要提这个问题" title="标题的直接链接">​</a></h3><p>常规的 c 程序要经过编译链接来生成可执行文件，链接的过程会按照链接脚本的配置来完成可执行文件的 layout 同时也会对所有的可重定位项目进行重定位，以确定访问地址偏移。</p><p>linux 内核模块也有类似的过程，可编译生成的内核模块只是一个【可重定位目标文件】，<strong>那它的链接过程是在哪里执行的呢？</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="经验之谈">经验之谈<a class="hash-link" href="#经验之谈" title="标题的直接链接">​</a></h2><p>内核模块一般通过 insmod、modprobe 命令加载运行，既然要运行，肯定需要确定模块内调用的外部符号的偏移地址，这一过程可能在如下流程中进行：</p><ol><li>insmod、modprobe 命令中</li><li>内核代码中模块加载流程中</li></ol><p>曾经 strace 跟踪过 insmod 加载内核模块的过程，核心逻辑是调用 finit_module、init_module 系统调用，没有看到其它操作，于是判断内核模块的链接应当是在内核代码中做的。</p><p>下面我以一个简单的 hello world 内核模块为例，探讨内核中执行模块链接的过程。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一个简单的内核模块源码">一个简单的内核模块源码<a class="hash-link" href="#一个简单的内核模块源码" title="标题的直接链接">​</a></h2><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;linux/module.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;linux/init.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> __init </span><span class="token function" style="color:#d73a49">my_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">printk</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">KERN_INFO </span><span class="token string" style="color:#e3116c">&quot;Hello from Hello Module\\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> __exit </span><span class="token function" style="color:#d73a49">my_exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">printk</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">KERN_INFO </span><span class="token string" style="color:#e3116c">&quot;Bye from Hello Module\\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">module_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">my_init</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">module_exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">my_exit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">MODULE_DESCRIPTION</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Sample Hello World Module&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">MODULE_LICENSE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;GPL&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>将上述内容保存为 mymodule.c 使用如下 Makefile 内容编译：</p><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">MODULE_FILENAME</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">mymodule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PWD </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">shell</span><span class="token plain"> pwd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obj-m </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">MODULE_FILENAME</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KO_FILE</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">MODULE_FILENAME</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">.ko</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> KROOT</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/lib/modules/</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">shell</span><span class="token plain"> uname -r</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">/build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token target symbol" style="color:#36acaa">modules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">@</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">MAKE</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> -C </span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">KROOT</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> M</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">PWD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token target symbol" style="color:#36acaa">modules_install</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">@</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">MAKE</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> -C </span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">KROOT</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> M</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">PWD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> modules_install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token target symbol" style="color:#36acaa">clean</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">@</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">MAKE</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> -C </span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">KROOT</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> M</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">PWD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> clean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rm -rf Modules.symvers modules.order</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token target symbol" style="color:#36acaa">insert</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> modules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo insmod </span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">KO_FILE</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token target symbol" style="color:#36acaa">remove</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo rmmod </span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">MODULE_FILENAME</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token target symbol" style="color:#36acaa">printlog</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo dmesg -c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo insmod </span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">KO_FILE</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dmesg</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="objdump--d-mymoduleko">objdump -d mymodule.ko<a class="hash-link" href="#objdump--d-mymoduleko" title="标题的直接链接">​</a></h2><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Disassembly of section .init.text:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000000000000000 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">init_module</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">:   e8 00 00 00 00          callq  </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">init_module+0x</span><span class="token operator file-descriptor important" style="color:#393A34">5</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">:   </span><span class="token number" style="color:#36acaa">48</span><span class="token plain"> c7 c7 00 00 00 00    mov    </span><span class="token variable" style="color:#36acaa">$0x0</span><span class="token plain">,%rdi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   c:   e8 00 00 00 00          callq  </span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">init_module+0x1</span><span class="token operator file-descriptor important" style="color:#393A34">1</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:   </span><span class="token number" style="color:#36acaa">31</span><span class="token plain"> c0                   xor    %eax,%eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:   c3                      retq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disassembly of section .exit.text:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000000000000000 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">cleanup_module</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">:   </span><span class="token number" style="color:#36acaa">48</span><span class="token plain"> c7 c7 00 00 00 00    mov    </span><span class="token variable" style="color:#36acaa">$0x0</span><span class="token plain">,%rdi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">7</span><span class="token plain">:   e9 00 00 00 00          jmpq   c </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">__UNIQUE_ID_description1</span><span class="token operator file-descriptor important" style="color:#393A34">8</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>init_module 为模块的初始化函数，在其中调用到的两个 <strong>callq</strong> 指令用于子函数调用。<strong>callq</strong> 指令的字节码为 <strong>0xe8</strong>，其后四个字节为函数跳转偏移，这里两个 <strong>callq</strong> 指令的函数跳转偏移值都为 0，这符合可重定位目标文件的特征，这里就是两处需要链接过程完成的重定位对象。</p><p>第二个 callq 可以明确是 printk，第一个 callq 根据 readelf -r 的输出判断是 <code>__fentry__ </code>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="readelf--r-mymoduleko">readelf -r mymodule.ko<a class="hash-link" href="#readelf--r-mymoduleko" title="标题的直接链接">​</a></h2><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Relocation section </span><span class="token string" style="color:#e3116c">&#x27;.rela.init.text&#x27;</span><span class="token plain"> at offset 0x1cb30 contains </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> entries:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000000000001  002600000004 R_X86_64_PLT32    0000000000000000 __fentry__ - </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000000000008  00060000000b R_X86_64_32S      0000000000000000 .rodata.str1.1 + </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000000000d  002800000004 R_X86_64_PLT32    0000000000000000 printk - </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Relocation section </span><span class="token string" style="color:#e3116c">&#x27;.rela.exit.text&#x27;</span><span class="token plain"> at offset 0x1cb78 contains </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> entries:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000000000003  00060000000b R_X86_64_32S      0000000000000000 .rodata.str1.1 + 1b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000000000008  002800000004 R_X86_64_PLT32    0000000000000000 printk - </span><span class="token number" style="color:#36acaa">4</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>readelf -r 参数获取可执行目标文件的可重定位 section 表项。上述输出中有如下两个可重定位 section:</p><ol><li>.rela.init.text</li><li>.rela.exit.text</li></ol><p>每个 section 中都列举出了【需要重定位的项目】，一个项目有五个方面的内容，其中 <strong>Offset 为可重定位目标地址相对文件起始地址的偏移量</strong>，<strong>Type 为重定位的类型</strong>，用于计算偏移地址，<strong>Sym. Name + Addend 字段为符号名称以及计算地址偏移量时的修正值。</strong></p><p><strong>.rela.init_text section</strong> 中有两种重定位类型，<strong>R_X86_64_PLT32</strong>  用于函数偏移计算，<strong>R_X86_64_32S</strong> 用于数据偏移计算。str1.1 实际指向 init_module 函数中 printk 函数打印的字符串。</p><p>函数偏移的计算可以参考如下内容来学习：</p><blockquote><p>So despite the fact that the type of the relocation entry is R_X86_64_PLT32 the linker will still use the R_X86_64_PC32 computation (S + A - P) for the relocation target being modified, where:</p><p>   S is the value of the symbol (st_value of Elf64_Sym)
A is the addend (-4 in your case)
P is the address of the memory location being relocated (the start of the address of the call to Other)</p></blockquote><p>上述英文摘自 <a href="https://stackoverflow.com/questions/64424692/how-does-the-address-of-r-x86-64-plt32-computed" target="_blank" rel="noopener noreferrer">How does the address of R_X86_64_PLT32 computed?</a> 更多的信息可以阅读《深入理解计算机系统》第三版 7.7 节。</p><p>在下文中我会用一个实例来说明函数偏移地址的计算过程。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="在内核源码中找到模块链接相关代码">在内核源码中找到模块链接相关代码<a class="hash-link" href="#在内核源码中找到模块链接相关代码" title="标题的直接链接">​</a></h2><p>使用 R_X86_64_PLT32 关键字进行如下搜索：</p><ol><li>搜索 kernel 目录</li><li>搜索 arch/x86 目录
确定模块链接流程在 arch/x86/kernel/module.c 中实现。</li></ol><p>阅读 module.c 的代码，发现有一个调试信息，于是修改内核代码，开启调试信息。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="内核代码修改-patch">内核代码修改 patch<a class="hash-link" href="#内核代码修改-patch" title="标题的直接链接">​</a></h2><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">diff </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">git a</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">arch</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">x86</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kernel</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">module</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c b</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">arch</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">x86</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kernel</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">module</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">index b052e883dd8c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">.11e39304</span><span class="token plain">c55f </span><span class="token number" style="color:#36acaa">100644</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> a</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">arch</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">x86</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kernel</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">module</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">++</span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> b</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">arch</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">x86</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">kernel</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">module</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">37</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">37</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> @@</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;asm/setup.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;asm/unwind.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain">#</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">#</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name function" style="color:#d73a49">DEBUGP</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">fmt</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa">                               \\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">printk</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">KERN_DEBUG fmt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ##__VA_ARGS__</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">196</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">196</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> @@ </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apply_relocate_add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Elf64_Shdr </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sechdrs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> invalid_relocation</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        val </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u32 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">if</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">val </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s32 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> overflow</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">212</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">213</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> @@ </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apply_relocate_add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Elf64_Shdr </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sechdrs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               me</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ELF64_R_TYPE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rel</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">r_info</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ENOEXEC</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">               </span><span class="token function" style="color:#d73a49">DEBUGP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;val is 0x%llx\\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="重新编译并更新内核后加载-mymoduleko-后-dmesg-部分打印信息">重新编译并更新内核后加载 mymodule.ko 后 dmesg 部分打印信息<a class="hash-link" href="#重新编译并更新内核后加载-mymoduleko-后-dmesg-部分打印信息" title="标题的直接链接">​</a></h2><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">109.974417</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token builtin class-name">type</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> st_value ffffffffbda016d0 r_addend fffffffffffffffc loc ffffffffc0106001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">109.974418</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> val is 0xfffffffffd8fb6cb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>由于打印信息很多，我只截取了其中的一条项目。在上述项目中关键的信息解析如下：</p><ol><li><p>type 4 表示重定位类型为 R_X86_64_PLT32 </p></li><li><p>st_value ffffffffbda016d0 表示 <code>__fentry__</code>符号地址</p><p>通过访问 /proc/kallsyms 文件确定，相关信息摘录如下；</p></li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">```bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@debian-10:17:55:34] helloworld_module # grep __fentry__ /proc/kallsyms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ffffffffbda016d0 T __fentry__</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">```</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li><p>r_addend fffffffffffffffc  为上文中 readelf -r 输出中 <code>__fentry__</code>函数的 Addend 值—— -4</p></li><li><p>loc ffffffffc0106001 表示上文中 readelf -r 输出中<code>__fentry__</code>被重定位区域在内核的实际地址</p></li><li><p>val is 0xfffffffffd8fb6cb，val 为最终计算出的访问 <code>__fentry__</code>函数的偏移量，会被填充到 loc 指向的地址中</p><p>val 计算公式为 S + A - P: ffffffffbda016d0 + fffffffffffffffc  - ffffffffc0106001 = <strong>0xfffffffffd8fb6cb</strong></p></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="核心内核代码">核心内核代码<a class="hash-link" href="#核心内核代码" title="标题的直接链接">​</a></h2><p>内核代码中相关函数调用关系如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">init_module</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">finit_module</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    load_module</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       apply_relocations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           apply_relocate_add</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>apply_relocate_add 函数中完成重定向任务，核心代码摘录如下：</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> sechdrs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">relsec</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sh_size </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">/* This is where to make the change */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                loc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">sechdrs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">sechdrs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">relsec</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sh_info</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sh_addr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> rel</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">r_offset</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">/* This is the symbol it is referring to.  Note that all</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                   undefined symbols have been resolved.  */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sym </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Elf64_Sym </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">sechdrs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">symindex</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sh_addr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ELF64_R_SYM</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rel</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">r_info</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">DEBUGP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;type %d st_value %Lx r_addend %Lx loc %Lx\\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">ELF64_R_TYPE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rel</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">r_info</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       sym</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">st_value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rel</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">r_addend</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                val </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sym</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">st_value </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> rel</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">r_addend</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">ELF64_R_TYPE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rel</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">r_info</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> R_X86_64_NONE</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> R_X86_64_64</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u64 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> invalid_relocation</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u64 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> R_X86_64_32</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u32 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> invalid_relocation</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u32 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">val </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u32 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> overflow</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> R_X86_64_32S</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s32 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> invalid_relocation</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s32 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">val </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s32 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> overflow</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> R_X86_64_PC32</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> R_X86_64_PLT32</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u32 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> invalid_relocation</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        val </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u32 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">loc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上述代码遍历每个可重定位 section 项目，loc 指向模块加载到内核后存储每个可重定位项目被重定位区域的内存地址，代表 <strong>R_X86_64_PLT32</strong>  中的标号 <strong>P</strong>。</p><p>sym 中保存已经 resolve 的未定义符号，sym-&gt;value 表示符号加载地址，代表 <strong>R_X86_64_PLT32</strong>  中的标号 <strong>S</strong>。</p><p>rel<!-- -->[i]<!-- -->.r_addend 保存可重定位项目的 <strong>Addend</strong> 值，代表 <strong>R_X86_64_PLT32</strong>  中的标号 <strong>A</strong>。</p><p>在确定了这些信息后，switch 语句通过可重定位项目的 Type 字段进行逻辑分发，计算并填充重定位后的地址。对于 R_X86_64_PLT32  这种类型来说，计算公式就是 <strong>S + A - P</strong>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a class="hash-link" href="#总结" title="标题的直接链接">​</a></h2><p>善于提问是一种很好的能力。主动发现并提出问题然后积极的寻找答案，最后给出合理的答案，收获成就感并推动自己继续提出新的问题，这是一个正反馈。从自己能够回答的小问题开始，不断的循环往复，雪球会越滚越大，时间正站在你这边。</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="博文分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/libc/使用mtrace跟踪内存泄露问题"><div class="pagination-nav__sublabel">较新一篇</div><div class="pagination-nav__label">libc/使用mtrace跟踪内存泄露问题</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/welcome"><div class="pagination-nav__sublabel">较旧一篇</div><div class="pagination-nav__label">Welcome</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#前言" class="table-of-contents__link toc-highlight">前言</a></li><li><a href="#我的问题" class="table-of-contents__link toc-highlight">我的问题</a><ul><li><a href="#1-linux-内核模块是如何链接的" class="table-of-contents__link toc-highlight">1. <strong>linux 内核模块是如何链接的？</strong></a></li><li><a href="#2-为什么要提这个问题" class="table-of-contents__link toc-highlight">2. 为什么要提这个问题？</a></li></ul></li><li><a href="#经验之谈" class="table-of-contents__link toc-highlight">经验之谈</a></li><li><a href="#一个简单的内核模块源码" class="table-of-contents__link toc-highlight">一个简单的内核模块源码</a></li><li><a href="#objdump--d-mymoduleko" class="table-of-contents__link toc-highlight">objdump -d mymodule.ko</a></li><li><a href="#readelf--r-mymoduleko" class="table-of-contents__link toc-highlight">readelf -r mymodule.ko</a></li><li><a href="#在内核源码中找到模块链接相关代码" class="table-of-contents__link toc-highlight">在内核源码中找到模块链接相关代码</a></li><li><a href="#内核代码修改-patch" class="table-of-contents__link toc-highlight">内核代码修改 patch</a></li><li><a href="#重新编译并更新内核后加载-mymoduleko-后-dmesg-部分打印信息" class="table-of-contents__link toc-highlight">重新编译并更新内核后加载 mymodule.ko 后 dmesg 部分打印信息</a></li><li><a href="#核心内核代码" class="table-of-contents__link toc-highlight">核心内核代码</a></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title"></div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/shaozongfan" target="_blank" rel="noopener noreferrer" class="footer__link-item">shaozongfan<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/shaozongfan" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ? 2025 蒲城小农的文字世界, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.b78e153e.js"></script>
<script src="/assets/js/main.8780ac4d.js"></script>
</body>
</html>