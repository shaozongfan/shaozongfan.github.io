"use strict";(self.webpackChunkshaozongfan_website=self.webpackChunkshaozongfan_website||[]).push([[5187],{3905:function(n,e,t){t.d(e,{Zo:function(){return u},kt:function(){return d}});var r=t(67294);function a(n,e,t){return e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function o(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,r)}return t}function i(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?o(Object(t),!0).forEach((function(e){a(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}function l(n,e){if(null==n)return{};var t,r,a=function(n,e){if(null==n)return{};var t,r,a={},o=Object.keys(n);for(r=0;r<o.length;r++)t=o[r],e.indexOf(t)>=0||(a[t]=n[t]);return a}(n,e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(n);for(r=0;r<o.length;r++)t=o[r],e.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(n,t)&&(a[t]=n[t])}return a}var p=r.createContext({}),m=function(n){var e=r.useContext(p),t=e;return n&&(t="function"==typeof n?n(e):i(i({},e),n)),t},u=function(n){var e=m(n.components);return r.createElement(p.Provider,{value:e},n.children)},_={inlineCode:"code",wrapper:function(n){var e=n.children;return r.createElement(r.Fragment,{},e)}},s=r.forwardRef((function(n,e){var t=n.components,a=n.mdxType,o=n.originalType,p=n.parentName,u=l(n,["components","mdxType","originalType","parentName"]),s=m(t),d=a,c=s["".concat(p,".").concat(d)]||s[d]||_[d]||o;return t?r.createElement(c,i(i({ref:e},u),{},{components:t})):r.createElement(c,i({ref:e},u))}));function d(n,e){var t=arguments,a=e&&e.mdxType;if("string"==typeof n||a){var o=t.length,i=new Array(o);i[0]=s;var l={};for(var p in e)hasOwnProperty.call(e,p)&&(l[p]=e[p]);l.originalType=n,l.mdxType="string"==typeof n?n:a,i[1]=l;for(var m=2;m<o;m++)i[m]=t[m];return r.createElement.apply(null,i)}return r.createElement.apply(null,t)}s.displayName="MDXCreateElement"},37538:function(n,e,t){t.r(e),t.d(e,{assets:function(){return u},contentTitle:function(){return p},default:function(){return d},frontMatter:function(){return l},metadata:function(){return m},toc:function(){return _}});var r=t(87462),a=t(63366),o=(t(67294),t(3905)),i=["components"],l={},p=void 0,m={unversionedId:"\u6280\u672f\u535a\u5ba2/\u5d4c\u5165\u5f0f/linux\u8bbe\u5907\u9a71\u52a8\u5f00\u53d1\u8be6\u89e3/11.4\u3000\u8bbe\u5907IO\u7aef\u53e3\u548cIO\u5185\u5b58\u7684\u8bbf\u95ee",id:"\u6280\u672f\u535a\u5ba2/\u5d4c\u5165\u5f0f/linux\u8bbe\u5907\u9a71\u52a8\u5f00\u53d1\u8be6\u89e3/11.4\u3000\u8bbe\u5907IO\u7aef\u53e3\u548cIO\u5185\u5b58\u7684\u8bbf\u95ee",title:"11.4\u3000\u8bbe\u5907IO\u7aef\u53e3\u548cIO\u5185\u5b58\u7684\u8bbf\u95ee",description:"\u8bbe\u5907\u901a\u5e38\u4f1a\u63d0\u4f9b\u4e00\u7ec4\u5bc4\u5b58\u5668\u6765\u63a7\u5236\u8bbe\u5907\u3001\u8bfb\u5199\u8bbe\u5907\u548c\u83b7\u53d6\u8bbe\u5907\u72b6\u6001\uff0c\u5373\u63a7\u5236\u5bc4\u5b58\u5668\u3001\u6570\u636e\u5bc4\u5b58\u5668\u548c\u72b6\u6001\u5bc4\u5b58\u5668\u3002\u8fd9\u4e9b\u5bc4\u5b58\u5668\u53ef\u80fd\u4f4d\u4e8eI/O\u7a7a\u95f4\u4e2d\uff0c\u4e5f\u53ef\u80fd\u4f4d\u4e8e\u5185\u5b58\u7a7a\u95f4\u4e2d\u3002\u5f53\u4f4d\u4e8eI/O\u7a7a\u95f4\u65f6\uff0c\u901a\u5e38\u88ab\u79f0\u4e3aI/O\u7aef\u53e3\uff1b\u5f53\u4f4d\u4e8e\u5185\u5b58\u7a7a\u95f4\u65f6\uff0c\u5bf9\u5e94\u7684\u5185\u5b58\u7a7a\u95f4\u88ab\u79f0\u4e3aI/O\u5185\u5b58\u3002",source:"@site/docs/\u6280\u672f\u535a\u5ba2/\u5d4c\u5165\u5f0f/linux\u8bbe\u5907\u9a71\u52a8\u5f00\u53d1\u8be6\u89e3/11.4\u3000\u8bbe\u5907IO\u7aef\u53e3\u548cIO\u5185\u5b58\u7684\u8bbf\u95ee.md",sourceDirName:"\u6280\u672f\u535a\u5ba2/\u5d4c\u5165\u5f0f/linux\u8bbe\u5907\u9a71\u52a8\u5f00\u53d1\u8be6\u89e3",slug:"/\u6280\u672f\u535a\u5ba2/\u5d4c\u5165\u5f0f/linux\u8bbe\u5907\u9a71\u52a8\u5f00\u53d1\u8be6\u89e3/11.4\u3000\u8bbe\u5907IO\u7aef\u53e3\u548cIO\u5185\u5b58\u7684\u8bbf\u95ee",permalink:"/docs/\u6280\u672f\u535a\u5ba2/\u5d4c\u5165\u5f0f/linux\u8bbe\u5907\u9a71\u52a8\u5f00\u53d1\u8be6\u89e3/11.4\u3000\u8bbe\u5907IO\u7aef\u53e3\u548cIO\u5185\u5b58\u7684\u8bbf\u95ee",draft:!1,editUrl:"https://github.com/shaozongfan/shaozongfan.github.io/docs/\u6280\u672f\u535a\u5ba2/\u5d4c\u5165\u5f0f/linux\u8bbe\u5907\u9a71\u52a8\u5f00\u53d1\u8be6\u89e3/11.4\u3000\u8bbe\u5907IO\u7aef\u53e3\u548cIO\u5185\u5b58\u7684\u8bbf\u95ee.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"11.3.1\u3000\u7528\u6237\u7a7a\u95f4\u5185\u5b58\u52a8\u6001\u7533\u8bf7",permalink:"/docs/\u6280\u672f\u535a\u5ba2/\u5d4c\u5165\u5f0f/linux\u8bbe\u5907\u9a71\u52a8\u5f00\u53d1\u8be6\u89e3/11.3\u3000\u5185\u5b58\u5b58\u53d6"},next:{title:"11.5\u3000IO\u5185\u5b58\u9759\u6001\u6620\u5c04",permalink:"/docs/\u6280\u672f\u535a\u5ba2/\u5d4c\u5165\u5f0f/linux\u8bbe\u5907\u9a71\u52a8\u5f00\u53d1\u8be6\u89e3/11.5\u3000IO\u5185\u5b58\u9759\u6001\u6620\u5c04"}},u={},_=[{value:"1.I/O\u7aef\u53e3",id:"1io\u7aef\u53e3",level:2},{value:"2.I/O\u5185\u5b58",id:"2io\u5185\u5b58",level:2},{value:"1.I/O\u7aef\u53e3\u7533\u8bf7",id:"1io\u7aef\u53e3\u7533\u8bf7",level:2},{value:"2.I/O\u5185\u5b58\u7533\u8bf7",id:"2io\u5185\u5b58\u7533\u8bf7",level:2},{value:"1.\u5185\u5b58\u6620\u5c04\u4e0eVMA",id:"1\u5185\u5b58\u6620\u5c04\u4e0evma",level:2},{value:"2.fault\uff08\uff09\u51fd\u6570",id:"2fault\u51fd\u6570",level:2}],s={toc:_};function d(n){var e=n.components,l=(0,a.Z)(n,i);return(0,o.kt)("wrapper",(0,r.Z)({},s,l,{components:e,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"\u8bbe\u5907\u901a\u5e38\u4f1a\u63d0\u4f9b\u4e00\u7ec4\u5bc4\u5b58\u5668\u6765\u63a7\u5236\u8bbe\u5907\u3001\u8bfb\u5199\u8bbe\u5907\u548c\u83b7\u53d6\u8bbe\u5907\u72b6\u6001\uff0c\u5373\u63a7\u5236\u5bc4\u5b58\u5668\u3001\u6570\u636e\u5bc4\u5b58\u5668\u548c\u72b6\u6001\u5bc4\u5b58\u5668\u3002\u8fd9\u4e9b\u5bc4\u5b58\u5668\u53ef\u80fd\u4f4d\u4e8eI/O\u7a7a\u95f4\u4e2d\uff0c\u4e5f\u53ef\u80fd\u4f4d\u4e8e\u5185\u5b58\u7a7a\u95f4\u4e2d\u3002\u5f53\u4f4d\u4e8eI/O\u7a7a\u95f4\u65f6\uff0c\u901a\u5e38\u88ab\u79f0\u4e3aI/O\u7aef\u53e3\uff1b\u5f53\u4f4d\u4e8e\u5185\u5b58\u7a7a\u95f4\u65f6\uff0c\u5bf9\u5e94\u7684\u5185\u5b58\u7a7a\u95f4\u88ab\u79f0\u4e3aI/O\u5185\u5b58\u3002"),(0,o.kt)("h1",{id:"1141linux-io\u7aef\u53e3\u548cio\u5185\u5b58\u8bbf\u95ee\u63a5\u53e3"},"11.4.1\u3000Linux I/O\u7aef\u53e3\u548cI/O\u5185\u5b58\u8bbf\u95ee\u63a5\u53e3"),(0,o.kt)("h2",{id:"1io\u7aef\u53e3"},"1.I/O\u7aef\u53e3"),(0,o.kt)("p",null,"\u5728Linux\u8bbe\u5907\u9a71\u52a8\u4e2d\uff0c\u5e94\u4f7f\u7528Linux\u5185\u6838\u63d0\u4f9b\u7684\u51fd\u6570\u6765\u8bbf\u95ee\u5b9a\u4f4d\u4e8eI/O\u7a7a\u95f4\u7684\u7aef\u53e3\uff0c\u8fd9\u4e9b\u51fd\u6570\u5305\u62ec\u5982\u4e0b\u51e0\u79cd\u3002"),(0,o.kt)("p",null,"1\uff09\u8bfb\u5199\u5b57\u8282\u7aef\u53e3\uff088\u4f4d\u5bbd\uff09\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"unsigned inb(unsigned port);\nvoid outb(unsigned char byte, unsigned port);\n")),(0,o.kt)("p",null,"2\uff09\u8bfb\u5199\u5b57\u7aef\u53e3\uff0816\u4f4d\u5bbd\uff09\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"unsigned inw(unsigned port);\nvoid outw(unsigned short word, unsigned port);\n")),(0,o.kt)("p",null,"3\uff09\u8bfb\u5199\u957f\u5b57\u7aef\u53e3\uff0832\u4f4d\u5bbd\uff09\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"unsigned inl(unsigned port);\nvoid outl(unsigned longword, unsigned port);\n")),(0,o.kt)("p",null,"4\uff09\u8bfb\u5199\u4e00\u4e32\u5b57\u8282\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"void insb(unsigned port, void *addr, unsigned long count);\nvoid outsb(unsigned port, void *addr, unsigned long count);\n")),(0,o.kt)("p",null,"5\uff09insb\uff08\uff09\u4ece\u7aef\u53e3port\u5f00\u59cb\u8bfbcount\u4e2a\u5b57\u8282\u7aef\u53e3\uff0c\u5e76\u5c06\u8bfb\u53d6\u7ed3\u679c\u5199\u5165addr\u6307\u5411\u7684\u5185\u5b58\uff1boutsb\uff08\uff09\u5c06addr\u6307\u5411\u7684\u5185\u5b58\u4e2d\u7684count\u4e2a\u5b57\u8282\u8fde\u7eed\u5199\u5165\u4ee5port\u5f00\u59cb\u7684\u7aef\u53e3\u3002"),(0,o.kt)("p",null,"6\uff09\u8bfb\u5199\u4e00\u4e32\u5b57\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"void insw(unsigned port, void *addr, unsigned long count);\nvoid outsw(unsigned port, void *addr, unsigned long count);\n")),(0,o.kt)("p",null,"7\uff09\u8bfb\u5199\u4e00\u4e32\u957f\u5b57\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"void insl(unsigned port, void *addr, unsigned long count);\nvoid outsl(unsigned port, void *addr, unsigned long count);\n")),(0,o.kt)("p",null,"\u4e0a\u8ff0\u5404\u51fd\u6570\u4e2dI/O\u7aef\u53e3\u53f7port\u7684\u7c7b\u578b\u9ad8\u5ea6\u4f9d\u8d56\u4e8e\u5177\u4f53\u7684\u786c\u4ef6\u5e73\u53f0\uff0c\u56e0\u6b64\uff0c\u8fd9\u91cc\u53ea\u662f\u5199\u51fa\u4e86unsigned\u3002"),(0,o.kt)("h2",{id:"2io\u5185\u5b58"},"2.I/O\u5185\u5b58"),(0,o.kt)("p",null,"\u5728\u5185\u6838\u4e2d\u8bbf\u95eeI/O\u5185\u5b58\uff08\u901a\u5e38\u662f\u82af\u7247\u5185\u90e8\u7684\u5404\u4e2aI2 C\u3001SPI\u3001USB\u7b49\u63a7\u5236\u5668\u7684\u5bc4\u5b58\u5668\u6216\u8005\u5916\u90e8\u5185\u5b58\u603b\u7ebf\u4e0a\u7684\u8bbe\u5907\uff09\u4e4b\u524d\uff0c\u9700\u9996\u5148\u4f7f\u7528ioremap\uff08\uff09\u51fd\u6570\u5c06\u8bbe\u5907\u6240\u5904\u7684\u7269\u7406\u5730\u5740\u6620\u5c04\u5230\u865a\u62df\u5730\u5740\u4e0a\u3002ioremap\uff08\uff09\u7684\u539f\u578b\u5982\u4e0b\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"void *ioremap(unsigned long offset, unsigned long size);\n")),(0,o.kt)("p",null,"ioremap\uff08\uff09\u4e0evmalloc\uff08\uff09\u7c7b\u4f3c\uff0c\u4e5f\u9700\u8981\u5efa\u7acb\u65b0\u7684\u9875\u8868\uff0c\u4f46\u662f\u5b83\u5e76\u4e0d\u8fdb\u884cvmalloc\uff08\uff09\u4e2d\u6240\u6267\u884c\u7684\u5185\u5b58\u5206\u914d\u884c\u4e3a\u3002ioremap\uff08\uff09\u8fd4\u56de\u4e00\u4e2a\u7279\u6b8a\u7684\u865a\u62df\u5730\u5740\uff0c\u8be5\u5730\u5740\u53ef\u7528\u6765\u5b58\u53d6\u7279\u5b9a\u7684\u7269\u7406\u5730\u5740\u8303\u56f4\uff0c\u8fd9\u4e2a\u865a\u62df\u5730\u5740\u4f4d\u4e8evmalloc\u6620\u5c04\u533a\u57df\u3002\u901a\u8fc7ioremap\uff08\uff09\u83b7\u5f97\u7684\u865a\u62df\u5730\u5740\u5e94\u8be5\u88abiounmap\uff08\uff09\u51fd\u6570\u91ca\u653e\uff0c\u5176\u539f\u578b\u5982\u4e0b\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"void iounmap(void * addr);\n")),(0,o.kt)("p",null,"ioremap\uff08\uff09\u6709\u4e2a\u53d8\u4f53\u662fdevm",(0,o.kt)("em",{parentName:"p"},"ioremap\uff08\uff09\uff0c\u7c7b\u4f3c\u4e8e\u5176\u4ed6\u4ee5devm"),"\u5f00\u5934\u7684\u51fd\u6570\uff0c\u901a\u8fc7devm_ioremap\uff08\uff09\u8fdb\u884c\u7684\u6620\u5c04\u901a\u5e38\u4e0d\u9700\u8981\u5728\u9a71\u52a8\u9000\u51fa\u548c\u51fa\u9519\u5904\u7406\u7684\u65f6\u5019\u8fdb\u884ciounmap\uff08\uff09\u3002devm_ioremap\uff08\uff09\u7684\u539f\u578b\u4e3a\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"void __iomem *devm_ioremap(struct device *dev, resource_size_t offset,\n                           unsigned long size);\n")),(0,o.kt)("p",null,"\u5728\u8bbe\u5907\u7684\u7269\u7406\u5730\u5740\uff08\u4e00\u822c\u90fd\u662f\u5bc4\u5b58\u5668\uff09\u88ab\u6620\u5c04\u5230\u865a\u62df\u5730\u5740\u4e4b\u540e\uff0c\u5c3d\u7ba1\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7\u6307\u9488\u8bbf\u95ee\u8fd9\u4e9b\u5730\u5740\uff0c\u4f46\u662fLinux\u5185\u6838\u63a8\u8350\u7528\u4e00\u7ec4\u6807\u51c6\u7684API\u6765\u5b8c\u6210\u8bbe\u5907\u5185\u5b58\u6620\u5c04\u7684\u865a\u62df\u5730\u5740\u7684\u8bfb\u5199\u3002"),(0,o.kt)("p",null,"\u8bfb\u5bc4\u5b58\u5668\u7528readb_relaxed\uff08\uff09\u3001readw_relaxed\uff08\uff09\u3001readl_relaxed\uff08\uff09\u3001readb\uff08\uff09\u3001readw\uff08\uff09\u3001readl\uff08\uff09\u8fd9\u4e00\u7ec4API\uff0c\u4ee5\u5206\u522b\u8bfb8bit\u300116bit\u300132bit\u7684\u5bc4\u5b58\u5668\uff0c\u6ca1\u6709_relaxed\u540e\u7f00\u7684\u7248\u672c\u4e0e\u6709_relaxed\u540e\u7f00\u7684\u7248\u672c\u7684\u533a\u522b\u662f\u6ca1\u6709_relaxed\u540e\u7f00\u7684\u7248\u672c\u5305\u542b\u4e00\u4e2a\u5185\u5b58\u5c4f\u969c\uff0c\u5982\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"#define readb(c)            ({ u8  __v = readb_relaxed(c); __iormb(); __v; })\n#define readw(c)            ({ u16__v = readw_relaxed(c); __iormb(); __v; })\n#define readl(c)            ({ u32 __v = readl_relaxed(c); __iormb(); __v; })\n")),(0,o.kt)("p",null,"\u5199\u5bc4\u5b58\u5668\u7528writeb_relaxed\uff08\uff09\u3001writew_relaxed\uff08\uff09\u3001writel_relaxed\uff08\uff09\u3001writeb\uff08\uff09\u3001writew\uff08\uff09\u3001writel\uff08\uff09\u8fd9\u4e00\u7ec4API\uff0c\u4ee5\u5206\u522b\u51998bit\u300116bit\u300132bit\u7684\u5bc4\u5b58\u5668\uff0c\u6ca1\u6709_relaxed\u540e\u7f00\u7684\u7248\u672c\u4e0e\u6709_relaxed\u540e\u7f00\u7684\u7248\u672c\u7684\u533a\u522b\u662f\u524d\u8005\u5305\u542b\u4e00\u4e2a\u5185\u5b58\u5c4f\u969c\uff0c\u5982\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"#define writeb(v,c)         ({ __iowmb(); writeb_relaxed(v,c); })\n#define writew(v,c)         ({ __iowmb(); writew_relaxed(v,c); })\n#define writel(v,c)         ({ __iowmb(); writel_relaxed(v,c); })\n")),(0,o.kt)("h1",{id:"1142\u7533\u8bf7\u4e0e\u91ca\u653e\u8bbe\u5907\u7684io\u7aef\u53e3\u548cio\u5185\u5b58"},"11.4.2\u3000\u7533\u8bf7\u4e0e\u91ca\u653e\u8bbe\u5907\u7684I/O\u7aef\u53e3\u548cI/O\u5185\u5b58"),(0,o.kt)("h2",{id:"1io\u7aef\u53e3\u7533\u8bf7"},"1.I/O\u7aef\u53e3\u7533\u8bf7"),(0,o.kt)("p",null,"Linux\u5185\u6838\u63d0\u4f9b\u4e86\u4e00\u7ec4\u51fd\u6570\u4ee5\u7533\u8bf7\u548c\u91ca\u653eI/O\u7aef\u53e3\uff0c\u8868\u660e\u8be5\u9a71\u52a8\u8981\u8bbf\u95ee\u8fd9\u7247\u533a\u57df\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"struct resource *request_region(unsigned long first, unsigned long n, const char *name);\n")),(0,o.kt)("p",null,"\u8fd9\u4e2a\u51fd\u6570\u5411\u5185\u6838\u7533\u8bf7n\u4e2a\u7aef\u53e3\uff0c\u8fd9\u4e9b\u7aef\u53e3\u4ecefirst\u5f00\u59cb\uff0cname\u53c2\u6570\u4e3a\u8bbe\u5907\u7684\u540d\u79f0\u3002\u5982\u679c\u5206\u914d\u6210\u529f\uff0c\u5219\u8fd4\u56de\u503c\u4e0d\u662fNULL\uff0c\u5982\u679c\u8fd4\u56deNULL\uff0c\u5219\u610f\u5473\u7740\u7533\u8bf7\u7aef\u53e3\u5931\u8d25\u3002"),(0,o.kt)("p",null,"\u5f53\u7528request_region\uff08\uff09\u7533\u8bf7\u7684I/O\u7aef\u53e3\u4f7f\u7528\u5b8c\u6210\u540e\uff0c\u5e94\u5f53\u4f7f\u7528release_region\uff08\uff09\u51fd\u6570\u5c06\u5b83\u4eec\u5f52\u8fd8\u7ed9\u7cfb\u7edf\uff0c\u8fd9\u4e2a\u51fd\u6570\u7684\u539f\u578b\u5982\u4e0b\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"void release_region(unsigned long start, unsigned long n);\n")),(0,o.kt)("h2",{id:"2io\u5185\u5b58\u7533\u8bf7"},"2.I/O\u5185\u5b58\u7533\u8bf7"),(0,o.kt)("p",null,"\u540c\u6837\uff0cLinux\u5185\u6838\u4e5f\u63d0\u4f9b\u4e86\u4e00\u7ec4\u51fd\u6570\u4ee5\u7533\u8bf7\u548c\u91ca\u653eI/O\u5185\u5b58\u7684\u8303\u56f4\u3002\u6b64\u5904\u7684\u201c\u7533\u8bf7\u201d\u8868\u660e\u8be5\u9a71\u52a8\u8981\u8bbf\u95ee\u8fd9\u7247\u533a\u57df\uff0c\u5b83\u4e0d\u4f1a\u505a\u4efb\u4f55\u5185\u5b58\u6620\u5c04\u7684\u52a8\u4f5c\uff0c\u66f4\u591a\u7684\u662f\u7c7b\u4f3c\u4e8e\u201creservation\u201d\u7684\u6982\u5ff5\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"struct resource *request_mem_region(unsigned long start, unsigned long len, char *name);\n")),(0,o.kt)("p",null,"\u8fd9\u4e2a\u51fd\u6570\u5411\u5185\u6838\u7533\u8bf7n\u4e2a\u5185\u5b58\u5730\u5740\uff0c\u8fd9\u4e9b\u5730\u5740\u4ecefirst\u5f00\u59cb\uff0cname\u53c2\u6570\u4e3a\u8bbe\u5907\u7684\u540d\u79f0\u3002\u5982\u679c\u5206\u914d\u6210\u529f\uff0c\u5219\u8fd4\u56de\u503c\u4e0d\u662fNULL\uff0c\u5982\u679c\u8fd4\u56deNULL\uff0c\u5219\u610f\u5473\u7740\u7533\u8bf7I/O\u5185\u5b58\u5931\u8d25\u3002"),(0,o.kt)("p",null,"\u5f53\u7528request_mem_region\uff08\uff09\u7533\u8bf7\u7684I/O\u5185\u5b58\u4f7f\u7528\u5b8c\u6210\u540e\uff0c\u5e94\u5f53\u4f7f\u7528release_mem_region\uff08\uff09\u51fd\u6570\u5c06\u5b83\u4eec\u5f52\u8fd8\u7ed9\u7cfb\u7edf\uff0c\u8fd9\u4e2a\u51fd\u6570\u7684\u539f\u578b\u5982\u4e0b\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"void release_mem_region(unsigned long start, unsigned long len);\n")),(0,o.kt)("p",null,"request_region\uff08\uff09\u548crequest_mem_region\uff08\uff09\u4e5f\u5206\u522b\u6709\u53d8\u4f53\uff0c\u5176\u4e3adevm_request_region\uff08\uff09\u548cdevm_request_mem_region\uff08\uff09\u3002"),(0,o.kt)("h1",{id:"1143\u8bbe\u5907io\u7aef\u53e3\u548cio\u5185\u5b58\u8bbf\u95ee\u6d41\u7a0b"},"11.4.3\u3000\u8bbe\u5907I/O\u7aef\u53e3\u548cI/O\u5185\u5b58\u8bbf\u95ee\u6d41\u7a0b"),(0,o.kt)("p",null,"\u7efc\u540811.3\u8282\u548c\u672c\u8282\u7684\u5185\u5bb9\uff0c\u53ef\u4ee5\u5f52\u7eb3\u51fa\u8bbe\u5907\u9a71\u52a8\u8bbf\u95eeI/O\u7aef\u53e3\u548cI/O\u5185\u5b58\u7684\u6b65\u9aa4\u3002"),(0,o.kt)("p",null,"I/O\u7aef\u53e3\u8bbf\u95ee\u7684\u4e00\u79cd\u9014\u5f84\u662f\u76f4\u63a5\u4f7f\u7528I/O\u7aef\u53e3\u64cd\u4f5c\u51fd\u6570\uff1a\u5728\u8bbe\u5907\u6253\u5f00\u6216\u9a71\u52a8\u6a21\u5757\u88ab\u52a0\u8f7d\u65f6\u7533\u8bf7I/O\u7aef\u53e3\u533a\u57df\uff0c\u4e4b\u540e\u4f7f\u7528inb\uff08\uff09\u3001outb\uff08\uff09\u7b49\u8fdb\u884c\u7aef\u53e3\u8bbf\u95ee\uff0c\u6700\u540e\uff0c\u5728\u8bbe\u5907\u5173\u95ed\u6216\u9a71\u52a8\u88ab\u5378\u8f7d\u65f6\u91ca\u653eI/O\u7aef\u53e3\u8303\u56f4\u3002\u6574\u4e2a\u6d41\u7a0b\u5982\u56fe11.10\u6240\u793a\u3002"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"1743863298618",src:t(13625).Z,width:"718",height:"424"})),(0,o.kt)("p",null,"\u56fe11.10\u3000I/O\u7aef\u53e3\u7684\u8bbf\u95ee\u6d41\u7a0b"),(0,o.kt)("p",null,"I/O\u5185\u5b58\u7684\u8bbf\u95ee\u6b65\u9aa4\u5982\u56fe11.11\u6240\u793a\uff0c\u9996\u5148\u662f\u8c03\u7528request_mem_region\uff08\uff09\u7533\u8bf7\u8d44\u6e90\uff0c\u63a5\u7740\u5c06\u5bc4\u5b58\u5668\u5730\u5740\u901a\u8fc7ioremap\uff08\uff09\u6620\u5c04\u5230\u5185\u6838\u7a7a\u95f4\u865a\u62df\u5730\u5740\uff0c\u4e4b\u540e\u5c31\u53ef\u4ee5\u901a\u8fc7Linux\u8bbe\u5907\u8bbf\u95ee\u7f16\u7a0b\u63a5\u53e3\u8bbf\u95ee\u8fd9\u4e9b\u8bbe\u5907\u7684\u5bc4\u5b58\u5668\u4e86\u3002\u8bbf\u95ee\u5b8c\u6210\u540e\uff0c\u5e94\u5bf9ioremap\uff08\uff09\u7533\u8bf7\u7684\u865a\u62df\u5730\u5740\u8fdb\u884c\u91ca\u653e\uff0c\u5e76\u91ca\u653erelease_mem_region\uff08\uff09\u7533\u8bf7\u7684I/O\u5185\u5b58\u8d44\u6e90\u3002"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"image-20250405222900505",src:t(51008).Z,width:"738",height:"642"})),(0,o.kt)("p",null,"\u56fe11.11\u3000I/O\u5185\u5b58\u8bbf\u95ee\u6d41\u7a0b"),(0,o.kt)("p",null,"\u6709\u65f6\u5019\uff0c\u9a71\u52a8\u5728\u8bbf\u95ee\u5bc4\u5b58\u5668\u6216I/O\u7aef\u53e3\u524d\uff0c\u4f1a\u7701\u53bbrequest_mem_region\uff08\uff09\u3001request_region\uff08\uff09\u8fd9\u6837\u7684\u8c03\u7528\u3002"),(0,o.kt)("h1",{id:"1144\u5c06\u8bbe\u5907\u5730\u5740\u6620\u5c04\u5230\u7528\u6237\u7a7a\u95f4"},"11.4.4\u3000\u5c06\u8bbe\u5907\u5730\u5740\u6620\u5c04\u5230\u7528\u6237\u7a7a\u95f4"),(0,o.kt)("h2",{id:"1\u5185\u5b58\u6620\u5c04\u4e0evma"},"1.\u5185\u5b58\u6620\u5c04\u4e0eVMA"),(0,o.kt)("p",null,"\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u7528\u6237\u7a7a\u95f4\u662f\u4e0d\u53ef\u80fd\u4e5f\u4e0d\u5e94\u8be5\u76f4\u63a5\u8bbf\u95ee\u8bbe\u5907\u7684\uff0c\u4f46\u662f\uff0c\u8bbe\u5907\u9a71\u52a8\u7a0b\u5e8f\u4e2d\u53ef\u5b9e\u73b0mmap\uff08\uff09\u51fd\u6570\uff0c\u8fd9\u4e2a\u51fd\u6570\u53ef\u4f7f\u5f97\u7528\u6237\u7a7a\u95f4\u80fd\u76f4\u63a5\u8bbf\u95ee\u8bbe\u5907\u7684\u7269\u7406\u5730\u5740\u3002\u5b9e\u9645\u4e0a\uff0cmmap\uff08\uff09\u5b9e\u73b0\u4e86\u8fd9\u6837\u7684\u4e00\u4e2a\u6620\u5c04\u8fc7\u7a0b\uff1a\u5b83\u5c06\u7528\u6237\u7a7a\u95f4\u7684\u4e00\u6bb5\u5185\u5b58\u4e0e\u8bbe\u5907\u5185\u5b58\u5173\u8054\uff0c\u5f53\u7528\u6237\u8bbf\u95ee\u7528\u6237\u7a7a\u95f4\u7684\u8fd9\u6bb5\u5730\u5740\u8303\u56f4\u65f6\uff0c\u5b9e\u9645\u4e0a\u4f1a\u8f6c\u5316\u4e3a\u5bf9\u8bbe\u5907\u7684\u8bbf\u95ee\u3002"),(0,o.kt)("p",null,"\u8fd9\u79cd\u80fd\u529b\u5bf9\u4e8e\u663e\u793a\u9002\u914d\u5668\u4e00\u7c7b\u7684\u8bbe\u5907\u975e\u5e38\u6709\u610f\u4e49\uff0c\u5982\u679c\u7528\u6237\u7a7a\u95f4\u53ef\u76f4\u63a5\u901a\u8fc7\u5185\u5b58\u6620\u5c04\u8bbf\u95ee\u663e\u5b58\u7684\u8bdd\uff0c\u5c4f\u5e55\u5e27\u7684\u5404\u70b9\u50cf\u7d20\u5c06\u4e0d\u518d\u9700\u8981\u4e00\u4e2a\u4ece\u7528\u6237\u7a7a\u95f4\u5230\u5185\u6838\u7a7a\u95f4\u7684\u590d\u5236\u7684\u8fc7\u7a0b\u3002"),(0,o.kt)("p",null,"mmap\uff08\uff09\u5fc5\u987b\u4ee5PAGE_SIZE\u4e3a\u5355\u4f4d\u8fdb\u884c\u6620\u5c04\uff0c\u5b9e\u9645\u4e0a\uff0c\u5185\u5b58\u53ea\u80fd\u4ee5\u9875\u4e3a\u5355\u4f4d\u8fdb\u884c\u6620\u5c04\uff0c\u82e5\u8981\u6620\u5c04\u975ePAGE_SIZE\u6574\u6570\u500d\u7684\u5730\u5740\u8303\u56f4\uff0c\u8981\u5148\u8fdb\u884c\u9875\u5bf9\u9f50\uff0c\u5f3a\u884c\u4ee5PAGE_SIZE\u7684\u500d\u6570\u5927\u5c0f\u8fdb\u884c\u6620\u5c04\u3002"),(0,o.kt)("p",null,"\u4ecefile_operations\u6587\u4ef6\u64cd\u4f5c\u7ed3\u6784\u4f53\u53ef\u4ee5\u770b\u51fa\uff0c\u9a71\u52a8\u4e2dmmap\uff08\uff09\u51fd\u6570\u7684\u539f\u578b\u5982\u4e0b\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"int(*mmap)(struct file *, struct vm_area_struct*);\n")),(0,o.kt)("p",null,"\u9a71\u52a8\u4e2d\u7684mmap\uff08\uff09\u51fd\u6570\u5c06\u5728\u7528\u6237\u8fdb\u884cmmap\uff08\uff09\u7cfb\u7edf\u8c03\u7528\u65f6\u6700\u7ec8\u88ab\u8c03\u7528\uff0cmmap\uff08\uff09\u7cfb\u7edf\u8c03\u7528\u7684\u539f\u578b\u4e0efile_operations\u4e2dmmap\uff08\uff09\u7684\u539f\u578b\u533a\u522b\u5f88\u5927\uff0c\u5982\u4e0b\u6240\u793a\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"caddr_t  mmap (caddr_t addr, size_t len, int prot, int flags, int fd, off_t offset);\n")),(0,o.kt)("p",null,"\u53c2\u6570fd\u4e3a\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u4e00\u822c\u7531open\uff08\uff09\u8fd4\u56de\uff0cfd\u4e5f\u53ef\u4ee5\u6307\u5b9a\u4e3a-1\uff0c\u6b64\u65f6\u9700\u6307\u5b9aflags\u53c2\u6570\u4e2d\u7684MAP_ANON\uff0c\u8868\u660e\u8fdb\u884c\u7684\u662f\u533f\u540d\u6620\u5c04\u3002"),(0,o.kt)("p",null,"len\u662f\u6620\u5c04\u5230\u8c03\u7528\u7528\u6237\u7a7a\u95f4\u7684\u5b57\u8282\u6570\uff0c\u5b83\u4ece\u88ab\u6620\u5c04\u6587\u4ef6\u5f00\u5934offset\u4e2a\u5b57\u8282\u5f00\u59cb\u7b97\u8d77\uff0coffset\u53c2\u6570\u4e00\u822c\u8bbe\u4e3a0\uff0c\u8868\u793a\u4ece\u6587\u4ef6\u5934\u5f00\u59cb\u6620\u5c04\u3002"),(0,o.kt)("p",null,"prot\u53c2\u6570\u6307\u5b9a\u8bbf\u95ee\u6743\u9650\uff0c\u53ef\u53d6\u5982\u4e0b\u51e0\u4e2a\u503c\u7684\u201c\u6216\u201d\uff1aPROT_READ\uff08\u53ef\u8bfb\uff09\u3001PROT_WRITE\uff08\u53ef\u5199\uff09\u3001PROT_EXEC\uff08\u53ef\u6267\u884c\uff09\u548cPROT_NONE\uff08\u4e0d\u53ef\u8bbf\u95ee\uff09\u3002"),(0,o.kt)("p",null,"\u53c2\u6570addr\u6307\u5b9a\u6587\u4ef6\u5e94\u88ab\u6620\u5c04\u5230\u7528\u6237\u7a7a\u95f4\u7684\u8d77\u59cb\u5730\u5740\uff0c\u4e00\u822c\u88ab\u6307\u5b9a\u4e3aNULL\uff0c\u8fd9\u6837\uff0c\u9009\u62e9\u8d77\u59cb\u5730\u5740\u7684\u4efb\u52a1\u5c06\u7531\u5185\u6838\u5b8c\u6210\uff0c\u800c\u51fd\u6570\u7684\u8fd4\u56de\u503c\u5c31\u662f\u6620\u5c04\u5230\u7528\u6237\u7a7a\u95f4\u7684\u5730\u5740\u3002\u5176\u7c7b\u578bcaddr_t\u5b9e\u9645\u4e0a\u5c31\u662fvoid*\u3002"),(0,o.kt)("p",null,"\u5f53\u7528\u6237\u8c03\u7528mmap\uff08\uff09\u7684\u65f6\u5019\uff0c\u5185\u6838\u4f1a\u8fdb\u884c\u5982\u4e0b\u5904\u7406\u3002"),(0,o.kt)("p",null,"1\uff09\u5728\u8fdb\u7a0b\u7684\u865a\u62df\u7a7a\u95f4\u67e5\u627e\u4e00\u5757VMA\u3002"),(0,o.kt)("p",null,"2\uff09\u5c06\u8fd9\u5757VMA\u8fdb\u884c\u6620\u5c04\u3002"),(0,o.kt)("p",null,"3\uff09\u5982\u679c\u8bbe\u5907\u9a71\u52a8\u7a0b\u5e8f\u6216\u8005\u6587\u4ef6\u7cfb\u7edf\u7684file_operations\u5b9a\u4e49\u4e86mmap\uff08\uff09\u64cd\u4f5c\uff0c\u5219\u8c03\u7528\u5b83\u3002"),(0,o.kt)("p",null,"4\uff09\u5c06\u8fd9\u4e2aVMA\u63d2\u5165\u8fdb\u7a0b\u7684VMA\u94fe\u8868\u4e2d\u3002"),(0,o.kt)("p",null,"file_operations\u4e2dmmap\uff08\uff09\u51fd\u6570\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\u5c31\u662f\u6b65\u9aa41\uff09\u627e\u5230\u7684VMA\u3002"),(0,o.kt)("p",null,"\u7531mmap\uff08\uff09\u7cfb\u7edf\u8c03\u7528\u6620\u5c04\u7684\u5185\u5b58\u53ef\u7531munmap\uff08\uff09\u89e3\u9664\u6620\u5c04\uff0c\u8fd9\u4e2a\u51fd\u6570\u7684\u539f\u578b\u5982\u4e0b\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"int munmap(caddr_t addr, size_t len );\n")),(0,o.kt)("p",null,"\u9a71\u52a8\u7a0b\u5e8f\u4e2dmmap\uff08\uff09\u7684\u5b9e\u73b0\u673a\u5236\u662f\u5efa\u7acb\u9875\u8868\uff0c\u5e76\u586b\u5145VMA\u7ed3\u6784\u4f53\u4e2dvm_operations_struct\u6307\u9488\u3002VMA\u5c31\u662fvm_area_struct\uff0c\u7528\u4e8e\u63cf\u8ff0\u4e00\u4e2a\u865a\u62df\u5185\u5b58\u533a\u57df\uff0cVMA\u7ed3\u6784\u4f53\u7684\u5b9a\u4e49\u5982\u4ee3\u7801\u6e05\u535511.4\u6240\u793a\u3002"),(0,o.kt)("p",null,"\u4ee3\u7801\u6e05\u535511.4\u3000VMA\u7ed3\u6784\u4f53"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"}," 1struct vm_area_struct {\n 2  /* The first cache line has the info for VMA tree walking. */\n 3\n 4  unsigned long vm_start;         /* Our start address within vm_mm. */\n 5  unsigned long vm_end;           /* The first byte after our end address\n 6                                     within vm_mm. */\n 7\n 8  /* linked list of VM areas per task, sorted by address */\n 9  struct vm_area_struct *vm_next, *vm_prev;\n10\n11  struct rb_node vm_rb;\n12\n13  ...\n14\n15  /* Second cache line starts here. */\n16\n17  struct mm_struct *vm_mm;         /* The address space we belong to. */\n18  pgprot_t vm_page_prot;           /* Access permissions of this VMA. */\n19  unsigned long vm_flags;          /* Flags, see mm.h. */\n20\n21  ...\n22  const struct vm_operations_struct *vm_ops;\n23\n24  /* Information about our backing store: */\n25  unsigned long vm_pgoff;          /* Offset (within vm_file) in PAGE_SIZE\n26                                      units, *not* PAGE_CACHE_SIZE */\n27  struct file * vm_file;           /* File we map to (can be NULL). */\n28  void * vm_private_data;          /* was vm_pte (shared mem) */\n29  ...\n30};\n")),(0,o.kt)("p",null,"VMA\u7ed3\u6784\u4f53\u63cf\u8ff0\u7684\u865a\u5730\u5740\u4ecb\u4e8evm_start\u548cvm_end\u4e4b\u95f4\uff0c\u800c\u5176vm_ops\u6210\u5458\u6307\u5411\u8fd9\u4e2aVMA\u7684\u64cd\u4f5c\u96c6\u3002\u9488\u5bf9VMA\u7684\u64cd\u4f5c\u90fd\u88ab\u5305\u542b\u5728vm_operations_struct\u7ed3\u6784\u4f53\u4e2d\uff0cvm_operations_struct\u7ed3\u6784\u4f53\u7684\u5b9a\u4e49\u5982\u4ee3\u7801\u6e05\u535511.5\u6240\u793a\u3002"),(0,o.kt)("p",null,"\u4ee3\u7801\u6e05\u535511.5\u3000vm_operations_struct\u7ed3\u6784\u4f53"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"}," 1struct vm_operations_struct {\n 2  void (*open)(struct vm_area_struct * area);\n 3  void (*close)(struct vm_area_struct * area);\n 4  int (*fault)(struct vm_area_struct *vma, struct vm_fault *vmf);\n 5  void (*map_pages)(struct vm_area_struct *vma, struct vm_fault *vmf);\n 6\n 7  /* notification that a previously read-only page is about to become\n 8   * writable, if an error is returned it will cause a SIGBUS */\n 9  int (*page_mkwrite)(struct vm_area_struct *vma, struct vm_fault *vmf);\n10\n11  /* called by access_process_vm when get_user_pages() fails, typically\n12   * for use by special VMAs that can switch between memory and hardware\n13   */\n14  int (*access)(struct vm_area_struct *vma, unsigned long addr,\n15            void *buf, int len, int write);\n16  \u2026\n17};\n")),(0,o.kt)("p",null,"\u6574\u4e2avm_operations_struct\u7ed3\u6784\u4f53\u7684\u5b9e\u4f53\u4f1a\u5728file_operations\u7684mmap\uff08\uff09\u6210\u5458\u51fd\u6570\u91cc\u88ab\u8d4b\u503c\u7ed9\u76f8\u5e94\u7684vma->vm_ops\uff0c\u800c\u4e0a\u8ff0open\uff08\uff09\u51fd\u6570\u4e5f\u901a\u5e38\u5728mmap\uff08\uff09\u91cc\u8c03\u7528\uff0cclose\uff08\uff09\u51fd\u6570\u4f1a\u5728\u7528\u6237\u8c03\u7528munmap\uff08\uff09\u7684\u65f6\u5019\u88ab\u8c03\u7528\u5230\u3002\u4ee3\u7801\u6e05\u535511.6\u7ed9\u51fa\u4e86\u4e00\u4e2avm_operations_struct\u7684\u64cd\u4f5c\u8303\u4f8b\u3002"),(0,o.kt)("p",null,"\u4ee3\u7801\u6e05\u535511.6\u3000vm_operations_struct\u64cd\u4f5c\u8303\u4f8b"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},' 1static int xxx_mmap(struct file *filp, struct vm_area_struct *vma)\n 2{\n 3  if (remap_pfn_range(vma, vma->vm_start, vm->vm_pgoff, vma->vm_end - vma\n 4    ->vm_start, vma->vm_page_prot))/* \u5efa\u7acb\u9875\u8868*/\n 5    return  -EAGAIN;\n 6  vma->vm_ops = &xxx_remap_vm_ops;\n 7  xxx_vma_open(vma);\n 8  return 0;\n 9}\n10\n11static void xxx_vma_open(struct vm_area_struct *vma)/* VMA\u6253\u5f00\u51fd\u6570*/\n12{\n13  ...\n14  printk(KERN_NOTICE "xxx VMA open, virt %lx, phys %lx\\n", vma->vm_start,\n15    vma->vm_pgoff << PAGE_SHIFT);\n16}\n17\n18static void xxx_vma_close(struct vm_area_struct *vma)/* VMA\u5173\u95ed\u51fd\u6570*/\n19{\n20  ...\n21  printk(KERN_NOTICE "xxx VMA close.\\n");\n22}\n23\n24static struct vm_operations_struct xxx_remap_vm_ops = {/* VMA\u64cd\u4f5c\u7ed3\u6784\u4f53*/\n25  .open = xxx_vma_open,\n26  .close = xxx_vma_close,\n27  ...\n28};\n')),(0,o.kt)("p",null,"\u7b2c3\u884c\u8c03\u7528\u7684remap_pfn_range\uff08\uff09\u521b\u5efa\u9875\u8868\u9879\uff0c\u4ee5VMA\u7ed3\u6784\u4f53\u7684\u6210\u5458\uff08VMA\u7684\u6570\u636e\u6210\u5458\u662f\u5185\u6838\u6839\u636e\u7528\u6237\u7684\u8bf7\u6c42\u81ea\u5df1\u586b\u5145\u7684\uff09\u4f5c\u4e3aremap_pfn_range\uff08\uff09\u7684\u53c2\u6570\uff0c\u6620\u5c04\u7684\u865a\u62df\u5730\u5740\u8303\u56f4\u662fvma->vm_start\u81f3vma->vm_end\u3002"),(0,o.kt)("p",null,"remap_pfn_range\uff08\uff09\u51fd\u6570\u7684\u539f\u578b\u5982\u4e0b\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"int remap_pfn_range(struct vm_area_struct *vma, unsigned long addr,\n          unsigned long pfn, unsigned long size, pgprot_t prot);\n")),(0,o.kt)("p",null,"\u5176\u4e2d\u7684addr\u53c2\u6570\u8868\u793a\u5185\u5b58\u6620\u5c04\u5f00\u59cb\u5904\u7684\u865a\u62df\u5730\u5740\u3002remap_pfn_range\uff08\uff09\u51fd\u6570\u4e3aaddr~addr+size\u7684\u865a\u62df\u5730\u5740\u6784\u9020\u9875\u8868\u3002"),(0,o.kt)("p",null,"pfn\u662f\u865a\u62df\u5730\u5740\u5e94\u8be5\u6620\u5c04\u5230\u7684\u7269\u7406\u5730\u5740\u7684\u9875\u5e27\u53f7\uff0c\u5b9e\u9645\u4e0a\u5c31\u662f\u7269\u7406\u5730\u5740\u53f3\u79fbPAGE_SHIFT\u4f4d\u3002\u82e5PAGE_SIZE\u4e3a4KB\uff0c\u5219PAGE_SHIFT\u4e3a12\uff0c\u56e0\u4e3aPAGE_SIZE\u7b49\u4e8e1<<PAGE_SHIFT\u3002"),(0,o.kt)("p",null,"prot\u662f\u65b0\u9875\u6240\u8981\u6c42\u7684\u4fdd\u62a4\u5c5e\u6027\u3002"),(0,o.kt)("p",null,"\u5728\u9a71\u52a8\u7a0b\u5e8f\u4e2d\uff0c\u6211\u4eec\u80fd\u4f7f\u7528remap_pfn_range\uff08\uff09\u6620\u5c04\u5185\u5b58\u4e2d\u7684\u4fdd\u7559\u9875\u3001\u8bbe\u5907I/O\u3001framebuffer\u3001camera\u7b49\u5185\u5b58\u3002\u5728remap_pfn_range\uff08\uff09\u4e0a\u53c8\u53ef\u4ee5\u8fdb\u4e00\u6b65\u5c01\u88c5\u51faio_remap_pfn_range\uff08\uff09\u3001vm_iomap_memory\uff08\uff09\u7b49API\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"#define io_remap_pfn_range remap_pfn_range\nint vm_iomap_memory(struct vm_area_struct *vma, phys_addr_t start, unsigned long len)\n{\n    unsigned long vm_len, pfn, pages;\n    ...\n    len += start & ~PAGE_MASK;\n    pfn = start >> PAGE_SHIFT;\n    pages = (len + ~PAGE_MASK) >> PAGE_SHIFT;\n    ...\n    pfn += vma->vm_pgoff;\n    pages -= vma->vm_pgoff;\n    /* Can we fit all of the mapping  */\n    vm_len = vma->vm_end - vma->vm_start;\n    ...\n    /* Ok, let it rip */\n    return io_remap_pfn_range(vma, vma->vm_start, pfn, vm_len, vma->vm_page_prot);\n}\n")),(0,o.kt)("p",null,"\u4ee3\u7801\u6e05\u535511.7\u7ed9\u51fa\u4e86LCD\u9a71\u52a8\u6620\u5c04framebuffer\u7269\u7406\u5730\u5740\u5230\u7528\u6237\u7a7a\u95f4\u7684\u5178\u578b\u8303\u4f8b\uff0c\u4ee3\u7801\u53d6\u81eadrivers/video/fbdev/core/fbmem.c\u3002"),(0,o.kt)("p",null,"\u4ee3\u7801\u6e05\u535511.7\u3000LCD\u9a71\u52a8\u6620\u5c04framebuffer\u7684mmap"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"}," 1static int\n 2fb_mmap(struct file *file, struct vm_area_struct * vma)\n 3{\n 4  struct fb_info *info = file_fb_info(file);\n 5  struct fb_ops *fb;\n 6  unsigned long mmio_pgoff;\n 7  unsigned long start;\n 8  u32len;\n 9\n10  if (!info)\n11       return -ENODEV;\n12  fb = info->fbops;\n13  if (!fb)\n14       return -ENODEV;\n15  mutex_lock(&info->mm_lock);\n16  if (fb->fb_mmap) {\n17       int res;\n18       res = fb->fb_mmap(info, vma);\n19       mutex_unlock(&info->mm_lock);\n20       return res;\n21  }\n22\n23  /*\n24   * Ugh. This can be either the frame buffer mapping, or\n25   * if pgoff points past it, the mmio mapping.\n26   */\n27  start = info->fix.smem_start;\n28  len = info->fix.smem_len;\n29  mmio_pgoff = PAGE_ALIGN((start & ~PAGE_MASK) + len) >> PAGE_SHIFT;\n30  if (vma->vm_pgoff >= mmio_pgoff) {\n31       if (info->var.accel_flags) {\n32             mutex_unlock(&info->mm_lock);\n33             return -EINVAL;\n34       }\n35\n36       vma->vm_pgoff -= mmio_pgoff;\n37       start = info->fix.mmio_start;\n38       len = info->fix.mmio_len;\n39  }\n40  mutex_unlock(&info->mm_lock);\n41\n42  vma->vm_page_prot = vm_get_page_prot(vma->vm_flags);\n43  fb_pgprotect(file, vma, start);\n44\n45  return vm_iomap_memory(vma, start, len);\n46}\n")),(0,o.kt)("p",null,"\u901a\u5e38\uff0cI/O\u5185\u5b58\u88ab\u6620\u5c04\u65f6\u9700\u8981\u662fnocache\u7684\uff0c\u8fd9\u65f6\u5019\uff0c\u6211\u4eec\u5e94\u8be5\u5bf9vma->vm_page_prot\u8bbe\u7f6enocache\u6807\u5fd7\u4e4b\u540e\u518d\u6620\u5c04\uff0c\u5982\u4ee3\u7801\u6e05\u535511.8\u6240\u793a\u3002"),(0,o.kt)("p",null,"\u4ee3\u7801\u6e05\u535511.8\u3000\u4ee5nocache\u65b9\u5f0f\u5c06\u5185\u6838\u7a7a\u95f4\u6620\u5c04\u5230\u7528\u6237\u7a7a\u95f4"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"}," 1static int xxx_nocache_mmap(struct file *filp, struct vm_area_struct *vma)\n 2{\n 3  vma->vm_page_prot = pgprot_noncached(vma->vm_page_prot);/* \u8d4bnocache\u6807\u5fd7 */\n 4  vma->vm_pgoff = ((u32)map_start >> PAGE_SHIFT);\n 5  /* \u6620\u5c04*/\n 6  if (remap_pfn_range(vma, vma->vm_start, vma->vm_pgoff, vma->vm_end - vma\n 7    ->vm_start, vma->vm_page_prot))\n 8    return  -EAGAIN;\n 9  return 0;\n10}\n")),(0,o.kt)("p",null,"\u4e0a\u8ff0\u4ee3\u7801\u7b2c3\u884c\u7684pgprot_noncached\uff08\uff09\u662f\u4e00\u4e2a\u5b8f\uff0c\u5b83\u9ad8\u5ea6\u4f9d\u8d56\u4e8eCPU\u7684\u4f53\u7cfb\u7ed3\u6784\uff0cARM\u7684pgprot_noncached\uff08\uff09\u5b9a\u4e49\u5982\u4e0b\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"#define pgprot_noncached(prot) \\\n        __pgprot_modify(prot, L_PTE_MT_MASK, L_PTE_MT_UNCACHED)\n")),(0,o.kt)("p",null,"\u53e6\u4e00\u4e2a\u6bd4pgprot_noncached\uff08\uff09\u7a0d\u5fae\u5c11\u4e00\u4e9b\u9650\u5236\u7684\u5b8f\u662fpgprot_writecombine\uff08\uff09\uff0c\u5b83\u7684\u5b9a\u4e49\u5982\u4e0b\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"#define pgprot_writecombine(prot) \\\n        __pgprot_modify(prot, L_PTE_MT_MASK, L_PTE_MT_BUFFERABLE)\n")),(0,o.kt)("p",null,"pgprot_noncached\uff08\uff09\u5b9e\u9645\u7981\u6b62\u4e86\u76f8\u5173\u9875\u7684Cache\u548c\u5199\u7f13\u51b2\uff08Write Buffer\uff09\uff0cpgprot_writecombine\uff08\uff09\u5219\u6ca1\u6709\u7981\u6b62\u5199\u7f13\u51b2\u3002ARM\u7684\u5199\u7f13\u51b2\u5668\u662f\u4e00\u4e2a\u975e\u5e38\u5c0f\u7684FIFO\u5b58\u50a8\u5668\uff0c\u4f4d\u4e8e\u5904\u7406\u5668\u6838\u4e0e\u4e3b\u5b58\u4e4b\u95f4\uff0c\u5176\u76ee\u7684\u5728\u4e8e\u5c06\u5904\u7406\u5668\u6838\u548cCache\u4ece\u8f83\u6162\u7684\u4e3b\u5b58\u5199\u64cd\u4f5c\u4e2d\u89e3\u8131\u51fa\u6765\u3002\u5199\u7f13\u51b2\u533a\u4e0eCache\u5728\u5b58\u50a8\u5c42\u6b21\u4e0a\u5904\u4e8e\u540c\u4e00\u5c42\u6b21\uff0c\u4f46\u662f\u5b83\u53ea\u4f5c\u7528\u4e8e\u5199\u4e3b\u5b58\u3002"),(0,o.kt)("h2",{id:"2fault\u51fd\u6570"},"2.fault\uff08\uff09\u51fd\u6570"),(0,o.kt)("p",null,"\u9664\u4e86remap_pfn_range\uff08\uff09\u4ee5\u5916\uff0c\u5728\u9a71\u52a8\u7a0b\u5e8f\u4e2d\u5b9e\u73b0VMA\u7684fault\uff08\uff09\u51fd\u6570\u901a\u5e38\u53ef\u4ee5\u4e3a\u8bbe\u5907\u63d0\u4f9b\u66f4\u52a0\u7075\u6d3b\u7684\u5185\u5b58\u6620\u5c04\u9014\u5f84\u3002\u5f53\u8bbf\u95ee\u7684\u9875\u4e0d\u5728\u5185\u5b58\u91cc\uff0c\u5373\u53d1\u751f\u7f3a\u9875\u5f02\u5e38\u65f6\uff0cfault\uff08\uff09\u4f1a\u88ab\u5185\u6838\u81ea\u52a8\u8c03\u7528\uff0c\u800cfault\uff08\uff09\u7684\u5177\u4f53\u884c\u4e3a\u53ef\u4ee5\u81ea\u5b9a\u4e49\u3002\u8fd9\u662f\u56e0\u4e3a\u5f53\u53d1\u751f\u7f3a\u9875\u5f02\u5e38\u65f6\uff0c\u7cfb\u7edf\u4f1a\u7ecf\u8fc7\u5982\u4e0b\u5904\u7406\u8fc7\u7a0b\u3002"),(0,o.kt)("p",null,"1\uff09\u627e\u5230\u7f3a\u9875\u7684\u865a\u62df\u5730\u5740\u6240\u5728\u7684VMA\u3002"),(0,o.kt)("p",null,"2\uff09\u5982\u679c\u5fc5\u8981\uff0c\u5206\u914d\u4e2d\u95f4\u9875\u76ee\u5f55\u8868\u548c\u9875\u8868\u3002"),(0,o.kt)("p",null,"3\uff09\u5982\u679c\u9875\u8868\u9879\u5bf9\u5e94\u7684\u7269\u7406\u9875\u9762\u4e0d\u5b58\u5728\uff0c\u5219\u8c03\u7528\u8fd9\u4e2aVMA\u7684fault\uff08\uff09\u65b9\u6cd5\uff0c\u5b83\u8fd4\u56de\u7269\u7406\u9875\u9762\u7684\u9875\u63cf\u8fcf\u7b26\u3002"),(0,o.kt)("p",null,"4\uff09\u5c06\u7269\u7406\u9875\u9762\u7684\u5730\u5740\u586b\u5145\u5230\u9875\u8868\u4e2d\u3002"),(0,o.kt)("p",null,"fault\uff08\uff09\u51fd\u6570\u5728Linux\u7684\u65e9\u671f\u7248\u672c\u4e2d\u547d\u540d\u4e3anopage\uff08\uff09\uff0c\u540e\u6765\u53d8\u66f4\u4e3a\u4e86fault\uff08\uff09\u3002\u4ee3\u7801\u6e05\u535511.9\u7ed9\u51fa\u4e86\u4e00\u4e2a\u8bbe\u5907\u9a71\u52a8\u4e2d\u4f7f\u7528fault\uff08\uff09\u7684\u5178\u578b\u8303\u4f8b\u3002"),(0,o.kt)("p",null,"\u4ee3\u7801\u6e05\u535511.9\u3000fault\uff08\uff09\u51fd\u6570\u4f7f\u7528\u8303\u4f8b"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"}," 1static int xxx_fault(struct vm_area_struct *vma, struct vm_fault *vmf)\n 2{\n 3  unsigned long paddr;\n 4  unsigned long pfn;\n 5  pgoff_t index = vmf->pgoff;\n 6  struct vma_data *vdata = vma->vm_private_data;\n 7\n 8  ...\n 9\n10  pfn = paddr >> PAGE_SHIFT;\n11\n12  vm_insert_pfn(vma, (unsigned long)vmf->virtual_address, pfn);\n13\n14  return VM_FAULT_NOPAGE;\n15} \n")),(0,o.kt)("p",null,"\u5927\u591a\u6570\u8bbe\u5907\u9a71\u52a8\u90fd\u4e0d\u9700\u8981\u63d0\u4f9b\u8bbe\u5907\u5185\u5b58\u5230\u7528\u6237\u7a7a\u95f4\u7684\u6620\u5c04\u80fd\u529b\uff0c\u56e0\u4e3a\uff0c\u5bf9\u4e8e\u4e32\u53e3\u7b49\u9762\u5411\u6d41\u7684\u8bbe\u5907\u800c\u8a00\uff0c\u5b9e\u73b0\u8fd9\u79cd\u6620\u5c04\u6beb\u65e0\u610f\u4e49\u3002\u800c\u5bf9\u4e8e\u663e\u793a\u3001\u89c6\u9891\u7b49\u8bbe\u5907\uff0c\u5efa\u7acb\u6620\u5c04\u53ef\u51cf\u5c11\u7528\u6237\u7a7a\u95f4\u548c\u5185\u6838\u7a7a\u95f4\u4e4b\u95f4\u7684\u5185\u5b58\u590d\u5236\u3002"))}d.isMDXComponent=!0},13625:function(n,e,t){e.Z=t.p+"assets/images/1743863298618-4a7e7ec8738f0c8e4ea6522316100833.png"},51008:function(n,e,t){e.Z=t.p+"assets/images/image-20250405222900505-d7b5478a3afa579f8e7afa5ce524a1a8.png"}}]);