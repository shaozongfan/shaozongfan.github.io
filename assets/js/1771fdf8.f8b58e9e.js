"use strict";(self.webpackChunkshaozongfan_website=self.webpackChunkshaozongfan_website||[]).push([[70877],{3905:function(e,t,r){r.d(t,{Zo:function(){return p},kt:function(){return b}});var n=r(67294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function f(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function c(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?f(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):f(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function i(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},f=Object.keys(e);for(n=0;n<f.length;n++)r=f[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var f=Object.getOwnPropertySymbols(e);for(n=0;n<f.length;n++)r=f[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var l=n.createContext({}),u=function(e){var t=n.useContext(l),r=t;return e&&(r="function"==typeof e?e(t):c(c({},t),e)),r},p=function(e){var t=u(e.components);return n.createElement(l.Provider,{value:t},e.children)},s={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},o=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,f=e.originalType,l=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),o=u(r),b=a,d=o["".concat(l,".").concat(b)]||o[b]||s[b]||f;return r?n.createElement(d,c(c({ref:t},p),{},{components:r})):n.createElement(d,c({ref:t},p))}));function b(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var f=r.length,c=new Array(f);c[0]=o;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:a,c[1]=i;for(var u=2;u<f;u++)c[u]=r[u];return n.createElement.apply(null,c)}return n.createElement.apply(null,r)}o.displayName="MDXCreateElement"},77053:function(e,t,r){r.r(t),r.d(t,{assets:function(){return p},contentTitle:function(){return l},default:function(){return b},frontMatter:function(){return i},metadata:function(){return u},toc:function(){return s}});var n=r(87462),a=r(63366),f=(r(67294),r(3905)),c=["components"],i={},l="\u4e00\uff0cringBuffer",u={permalink:"/blog/\u6280\u672f\u535a\u5ba2/\u8c03\u8bd5/Linux\u6027\u80fd\u5de5\u5177(\u4e09)ftrace\u6846\u67b6",editUrl:"https://github.com/shaozongfan/shaozongfan.github.io/blog/\u6280\u672f\u535a\u5ba2/\u8c03\u8bd5/Linux\u6027\u80fd\u5de5\u5177(\u4e09)ftrace\u6846\u67b6.md",source:"@site/blog/\u6280\u672f\u535a\u5ba2/\u8c03\u8bd5/Linux\u6027\u80fd\u5de5\u5177(\u4e09)ftrace\u6846\u67b6.md",title:"\u4e00\uff0cringBuffer",description:"Ringbuffer\u662ftrace32\u6846\u67b6\u7684\u4e00\u4e2a\u57fa\u7840\uff0c\u6240\u6709\u7684trace\u539f\u59cb\u6570\u636e\u90fd\u662f\u901a\u8fc7Ring Buffer\u8bb0\u5f55\u7684\uff0c\u5176\u4e3b\u8981\u6709\u4ee5\u4e0b\u51e0\u4e2a\u4f5c\u7528\uff1a",date:"2025-09-15T14:44:16.789Z",formattedDate:"2025\u5e749\u670815\u65e5",tags:[],readingTime:16.88,truncated:!1,authors:[],frontMatter:{},prevItem:{title:"\u6280\u672f\u535a\u5ba2/\u8c03\u8bd5/\u4fe1\u53f7\u673a\u5236\u5b66\u4e60\u8bb0\u5f55",permalink:"/blog/\u6280\u672f\u535a\u5ba2/\u8c03\u8bd5/\u4fe1\u53f7\u673a\u5236\u5b66\u4e60\u8bb0\u5f55"},nextItem:{title:"\u6280\u672f\u535a\u5ba2/\u7f51\u7edc/\u7f51\u7edc\u95ee\u9898",permalink:"/blog/\u6280\u672f\u535a\u5ba2/\u7f51\u7edc/\u7f51\u7edc\u95ee\u9898"}},p={authorsImageUrls:[]},s=[{value:"1.1 Ring buffer\u8bbe\u8ba1\u601d\u8def",id:"11-ring-buffer\u8bbe\u8ba1\u601d\u8def",level:2},{value:"1.2 \u4ee3\u7801\u6d41\u7a0b\u548c\u6846\u67b6",id:"12-\u4ee3\u7801\u6d41\u7a0b\u548c\u6846\u67b6",level:2},{value:"2.1 Function tracer\u7684\u5b9e\u73b0",id:"21-function-tracer\u7684\u5b9e\u73b0",level:2},{value:"2.1.1 \u9759\u6001\u63d2\u6869",id:"211-\u9759\u6001\u63d2\u6869",level:3},{value:"2.1.2 \u52a8\u6001\u63d2\u6869",id:"212-\u52a8\u6001\u63d2\u6869",level:3},{value:"2.1.3 irqs off/preempt off/preempt irqsoff tracer",id:"213-irqs-offpreempt-offpreempt-irqsoff-tracer",level:3},{value:"2.2 trace event",id:"22-trace-event",level:2},{value:"2.2.1 \u589e\u52a0\u4e00\u4e2a\u65b0\u7684 trace event",id:"221-\u589e\u52a0\u4e00\u4e2a\u65b0\u7684-trace-event",level:3}],o={toc:s};function b(e){var t=e.components,i=(0,a.Z)(e,c);return(0,f.kt)("wrapper",(0,n.Z)({},o,i,{components:t,mdxType:"MDXLayout"}),(0,f.kt)("p",null,"Ringbuffer\u662ftrace32\u6846\u67b6\u7684\u4e00\u4e2a\u57fa\u7840\uff0c\u6240\u6709\u7684trace\u539f\u59cb\u6570\u636e\u90fd\u662f\u901a\u8fc7Ring Buffer\u8bb0\u5f55\u7684\uff0c\u5176\u4e3b\u8981\u6709\u4ee5\u4e0b\u51e0\u4e2a\u4f5c\u7528\uff1a"),(0,f.kt)("ul",null,(0,f.kt)("li",{parentName:"ul"},"\u5b58\u50a8\u5728\u5185\u5b58\u4e2d\uff0c\u901f\u5ea6\u975e\u5e38\u5feb\uff0c\u5bf9\u7cfb\u7edf\u7684\u6027\u80fd\u5f71\u54cd\u964d\u5230\u6700\u4f4e\u7684\u6c34\u5e73"),(0,f.kt)("li",{parentName:"ul"},"ring\u7ed3\u6784\uff0c\u53ef\u4ee5\u5faa\u73af\u5199\uff0c\u5b89\u5168\u800c\u4e0d\u6d6a\u8d39\u5185\u5b58\u7a7a\u95f4\uff0c\u80fd\u591fget\u5230\u6700\u65b0\u7684trace\u4fe1\u606f")),(0,f.kt)("p",null,"\u5bf9\u4e8e\u7cfb\u7edf\uff0c\u771f\u6b63\u7684\u96be\u70b9\u5728\u4e8e\u7cfb\u7edf\u5728\u5404\u79cd\u590d\u6742\u7684\u573a\u666f\u4e0b\uff0c\u4f8b\u5982\u5e38\u89c4\u7684\u4e0a\u4e0b\u6587\u3001\u4e2d\u65ad\u4e0a\u4e0b\u6587(NMI/IRQ/SOFTIRQ)\u7b49\u90fd\u80fd\u5f88\u597d\u7684trace\uff0c\u5982\u4f55\u4fdd\u8bc1\u65e2\u4e0d\u5f71\u54cd\u7cfb\u7edf\u7684\u903b\u8f91\uff0c\u53c8\u80fd\u5904\u7406\u597d\u76f8\u4e92\u4e4b\u95f4\u7684\u5173\u7cfb\uff0c\u540c\u65f6\u53c8\u4e0d\u5f71\u54cd\u7cfb\u7edf\u7684\u6027\u80fd\u3002"),(0,f.kt)("h2",{id:"11-ring-buffer\u8bbe\u8ba1\u601d\u8def"},"1.1 Ring buffer\u8bbe\u8ba1\u601d\u8def"),(0,f.kt)("p",null,"\u5bf9\u4e8eRing Buffer\u9762\u4e34\u7684\u6700\u5927\u95ee\u9898"),(0,f.kt)("ul",null,(0,f.kt)("li",{parentName:"ul"},"\u5f53\u6211\u4eec\u4f7f\u7528trace\u5de5\u5177\u7684\u65f6\u5019\uff0c\u53ef\u80fd\u5904\u5728\u4e0d\u540c\u7684\u4e0a\u4e0b\u6587\u4e2d\u6267\u884c\uff0c\u5bf9Ring Buffer\u7684\u8bbf\u95ee\u65f6\u968f\u65f6\u53ef\u80fd\u88ab\u6253\u65ad\u7684\uff0c\u6240\u4ee5\u9700\u8981\u5bf9Ring Buffer\u7684\u8bbf\u95ee\u65f6\u9700\u8981\u4e92\u65a5\u4fdd\u62a4\u7684"),(0,f.kt)("li",{parentName:"ul"},"RingBuffer\u4e0d\u80fd\u4f7f\u7528\u5e38\u89c4\u7684lock\u64cd\u4f5c\uff0c\u8fd9\u6837\u4f1a\u4f7f\u4e0d\u540c\u7684\u4e0a\u4e0b\u6587\u4e4b\u95f4\u51fa\u73b0\u5927\u91cf\u7684\u963b\u585e\u64cd\u4f5c\uff0c\u4ea7\u751f\u4e86\u5927\u91cf\u7684\u8026\u5408\u903b\u8f91\uff0c\u5f71\u54cd\u7a0b\u5e8f\u539f\u7406\u7684\u903b\u8f91\u548c\u6027\u80fd")),(0,f.kt)("p",null,"\u4f55\u89e3\u51b3\u8fd9\u4e9b\u95ee\u9898\u5462\uff1f\u9996\u5148\u4eceRing Buffer\u4f7f\u7528\u7684\u65b9\u5f0f\u6765\u770b\uff0c\u5de5\u4f5c\u6a21\u5f0f\uff0c\u5bf9\u4e8e\u8be5\u6a21\u5f0f\uff0c\u662f\u4e00\u4e2a\u5f88\u5178\u578b\u7684\u751f\u4ea7\u8005\u548c\u6d88\u8d39\u8005\uff0c\u5176\u4e3b\u8981\u5206\u4e3a\uff1a"),(0,f.kt)("ul",null,(0,f.kt)("li",{parentName:"ul"},"Producer/Consumer\u6a21\u5f0f\uff1a \u6709\u4e0d\u65ad\u7684\u6570\u636e\u5199\u5165\u5230Ring Buffer\uff0c\u662f\u4e00\u4e2a\u5199\u5165\u8005\uff1b\u540c\u65f6\u5bf9\u4e8e\u7528\u6237\u4e5f\u4e0d\u65ad\u7684\u4eceRingBuffer\u4e2d\u8bfb\u53d6\u6570\u636e\uff0c\u5728\u751f\u4ea7\u8005\u5df2\u7ecf\u628aRing Buffer\u7a7a\u95f4\u5199\u6ee1\u7684\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u6ca1\u6709\u6d88\u8d39\u8005\u6765\u8bfb\u53d6\u6570\u636e\uff0c\u6ca1\u6709Free\u7a7a\u95f4\uff0c\u90a3\u4e48\u751f\u4ea7\u8005\u5c31\u4f1a\u505c\u6b62\u5199\u5165\u4e22\u5f03\u65b0\u7684\u6570\u636e"),(0,f.kt)("li",{parentName:"ul"},"Overwrite\u6a21\u5f0f\uff1a \u5728\u751f\u4ea7\u8005\u5df2\u7ecf\u628aRing Buffer\u7a7a\u95f4\u5199\u6ee1\u7684\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u6ca1\u6709\u6d88\u8d39\u8005\u6765\u8bfb\u6570\u636efree\u7a7a\u95f4\uff0c\u751f\u4ea7\u8005\u4f1a\u8986\u76d6\u5199\u5165\uff0c\u6700\u8001\u7684\u6570\u636e\u4f1a\u88ab\u8986\u76d6\uff1b")),(0,f.kt)("p",null,"\u5176\u6b21\uff0c\u4ece\u67b6\u6784\u56fe\u4e2d\uff0c\u6211\u4eec\u9762\u5bf9\u6709\u5f88\u591a\u7684\u5199\u8005\uff0c\u5bf9\u4e8e\u540c\u4e00\u4e2aper cpu\u7684RingBuffer\uff0c\u5176\u5199\u5fc5\u987b\u6ee1\u8db3\uff1a"),(0,f.kt)("ul",null,(0,f.kt)("li",{parentName:"ul"},"\u4e0d\u80fd\u540c\u65f6\u6709\u4e24\u4e2a\u5199\u5165\u8005\u5728\u8fdb\u884c\u5199\u64cd\u4f5c"),(0,f.kt)("li",{parentName:"ul"},"\u5141\u8bb8\u9ad8\u4f18\u5148\u7ea7\u7684\u5199\u5165\u8005\u4e2d\u65ad\u4f4e\u4f18\u5148\u7ea7\u7684\u5199\u5165\u8005")),(0,f.kt)("p",null,(0,f.kt)("strong",{parentName:"p"},"\u5bf9\u4e8e\u8bfb\u64cd\u4f5c\u5fc5\u987b\u8981\u6ee1\u8db3\uff1a")),(0,f.kt)("ul",null,(0,f.kt)("li",{parentName:"ul"},"\u8bfb\u64cd\u4f5c\u53ef\u4ee5\u968f\u65f6\u53d1\u751f\uff0c\u4f46\u662f\u540c\u4e00\u65f6\u523b\u53ea\u6709\u4e00\u4e2a\u8bfb\u8005\u5728\u5de5\u4f5c"),(0,f.kt)("li",{parentName:"ul"},"\u8bfb\u64cd\u4f5c\u548c\u5199\u64cd\u4f5c\u53ef\u4ee5\u540c\u65f6\u53d1\u751f"),(0,f.kt)("li",{parentName:"ul"},"\u8bfb\u64cd\u4f5c\u4e0d\u4f1a\u4e2d\u65ad\u5199\u64cd\u4f5c\uff0c\u4f46\u662f\u5199\u64cd\u4f5c\u4f1a\u4e2d\u65ad\u8bfb\u64cd\u4f5c"),(0,f.kt)("li",{parentName:"ul"},'\u652f\u6301\u4e24\u79cd\u6a21\u5f0f\u7684\u8bfb\u64cd\u4f5c\uff1a\u7b80\u6613\u8bfb\uff0c\u4e5f\u53ebiterator\u8bfb\uff0c\u5728\u8bfb\u53d6\u65f6\u4f1a\u5173\u95ed\u5199\u5165\uff0c\u4e14\u8bfb\u5b8c\u4e0d\u4f1a\u7834\u574f\u6570\u636e\u53ef\u4ee5\u91cd\u590d\u8bfb\u53d6\uff0c\u5b9e\u4f8b\u89c1"/sys/kernel/debug/tracing/trace"\uff1b\u5e76\u884c\u8bfb\uff0c\u4e5f\u53ebcustom\u8bfb\uff0c\u5e38\u7528\u4e8e\u76d1\u63a7\u7a0b\u5e8f\u5b9e\u65f6\u5730\u8fdb\u884c\u5e76\u884c\u8bfb\uff0c\u5176\u5229\u7528\u4e86\u4e00\u4e2areader page\u4ea4\u6362\u51faring buffer\u4e2d\u7684head page\uff0c\u907f\u514d\u4e86\u8bfb\u5199\u7684\u76f8\u4e92\u963b\u585e\uff0c\u5b9e\u4f8b\u89c1"/sys/kernel/debug/tracing/trace_pipe"\uff1b')),(0,f.kt)("h2",{id:"12-\u4ee3\u7801\u6d41\u7a0b\u548c\u6846\u67b6"},"1.2 \u4ee3\u7801\u6d41\u7a0b\u548c\u6846\u67b6"),(0,f.kt)("p",null,"\u5bf9\u4e8eRingbuffer\u7684\u521d\u59cb\u5316\uff0c\u4e3b\u8981\u662f\u901a\u8fc7tracer_alloc_buffers\u8c03\u7528\u5230ring_buffer_alloc\u5b8c\u6210\u7684\uff0c\u5176\u4e3b\u8981\u6d41\u7a0b\u5982\u4e0b\uff1a"),(0,f.kt)("pre",null,(0,f.kt)("code",{parentName:"pre"},"\n/**\n * __ring_buffer_alloc - allocate a new ring_buffer\n * @size: the size in bytes per cpu that is needed.\n * @flags: attributes to set for the ring buffer.\n *\n * Currently the only flag that is available is the RB_FL_OVERWRITE\n * flag. This flag means that the buffer will overwrite old data\n * when the buffer wraps. If this flag is not set, the buffer will\n * drop data when the tail hits the head.\n */\nstruct ring_buffer *__ring_buffer_alloc(unsigned long size, unsigned flags,\n                    struct lock_class_key *key)\n{\n    struct ring_buffer *buffer;\n    long nr_pages;\n    int bsize;\n    int cpu;\n    int ret;\n\n    /* keep it in its own cache line */\n    buffer = kzalloc(ALIGN(sizeof(*buffer), cache_line_size()),\n             GFP_KERNEL);        /*\u5206\u914dring_buffer\u6570\u636e\u7ed3\u6784*/\n    if (!buffer)\n        return NULL;\n\n    if (!zalloc_cpumask_var(&buffer->cpumask, GFP_KERNEL))\n        goto fail_free_buffer;\n\n    nr_pages = DIV_ROUND_UP(size, BUF_PAGE_SIZE);\n    buffer->flags = flags;\n    buffer->clock = trace_clock_local;\n    buffer->reader_lock_key = key;\n\n    init_irq_work(&buffer->irq_work.work, rb_wake_up_waiters);\n    init_waitqueue_head(&buffer->irq_work.waiters);\n\n    /* need at least two pages */\n    if (nr_pages < 2)\n        nr_pages = 2;\n\n    buffer->cpus = nr_cpu_ids;\n\n    bsize = sizeof(void *) * nr_cpu_ids;\n    buffer->buffers = kzalloc(ALIGN(bsize, cache_line_size()),\n                  GFP_KERNEL);\n    if (!buffer->buffers)\n        goto fail_free_cpumask;\n\n    cpu = raw_smp_processor_id();\n    cpumask_set_cpu(cpu, buffer->cpumask);\n    buffer->buffers[cpu] = rb_allocate_cpu_buffer(buffer, nr_pages, cpu);\n    if (!buffer->buffers[cpu])\n        goto fail_free_buffers;\n\n    ret = cpuhp_state_add_instance(CPUHP_TRACE_RB_PREPARE, &buffer->node);\n    if (ret < 0)\n        goto fail_free_buffers;\n\n    mutex_init(&buffer->mutex);\n\n    return buffer;\n\n fail_free_buffers:\n    for_each_buffer_cpu(buffer, cpu) { /*\u4e3a\u6bcf\u4e2aCPU\u5206\u914dring_buffer\u7684per cpu\u673a\u6784*/\n        if (buffer->buffers[cpu])\n            rb_free_cpu_buffer(buffer->buffers[cpu]);\n    }\n    kfree(buffer->buffers);\n\n fail_free_cpumask:\n    free_cpumask_var(buffer->cpumask);\n\n fail_free_buffer:\n    kfree(buffer);\n    return NULL;\n}\nEXPORT_SYMBOL_GPL(__ring_buffer_alloc);\n")),(0,f.kt)("p",null,"\u5176\u4e3b\u8981\u6570\u636e\u7ed3\u6784\u5982\u4e0b\u56fe\u6240\u793a\uff1a"),(0,f.kt)("p",null,(0,f.kt)("img",{alt:"image-20250326225000375",src:r(37540).Z,width:"1525",height:"1197"})),(0,f.kt)("ul",null,(0,f.kt)("li",{parentName:"ul"},"struct ring_buffer\u5728\u6bcf\u4e2acpu\u4e0a\u6709\u72ec\u7acb\u7684struct ring_buffer_per_cpu\u6570\u636e\u7ed3\u6784"),(0,f.kt)("li",{parentName:"ul"},"struct ring_buffer_per_cpu\u6839\u636e\u5b9a\u4e49size\u7684\u5927\u5c0f\uff0c\u5206\u914dpage\u7a7a\u95f4\uff0c\u5e76\u628apage\u8fde\u6210\u73af\u5f62\u7ed3\u6784"),(0,f.kt)("li",{parentName:"ul"},"struct buffer_page\u662f\u4e00\u4e2a\u63a7\u5236\u7ed3\u6784\uff1bstruct buffer_data_page\u624d\u662f\u4e00\u4e2a\u5b9e\u9645\u7684page\uff0c\u9664\u4e86\u5f00\u5934\u7684\u4e24\u4e2a\u63a7\u5236\u5b57\u6bb5time_stamp\u3001commit\uff0c\u5176\u4ed6\u7a7a\u95f4\u90fd\u662f\u7528\u6765\u5b58\u50a8\u6570\u636e\u7684\uff1b\u6570\u636e\u4f7f\u7528struct ring_buffer_event\u6765\u5b58\u50a8\uff0c\u5176\u5728\u5305\u5934\u4e2d\u8fd8\u5b58\u50a8\u4e86\u65f6\u95f4\u6233\u3001\u957f\u5ea6/\u7c7b\u578b\u4fe1\u606f"),(0,f.kt)("li",{parentName:"ul"},"struct ring_buffer_per_cpu\u4e2d\u4f7f\u7528head_page(\u8bfb)\u3001commit_page(\u5199\u786e\u8ba4)\u3001tail_page(\u5199)\u4e09\u79cd\u6307\u9488\u6765\u7ba1\u7406page ring\uff1b\u540c\u7406buffer_page->read(\u8bfb)\u3001buffer_page->write(\u5199)\u3001buffer_data_page->commit(\u5199\u786e\u8ba4)\u7528\u6765\u63cf\u8ff0page\u5185\u7684\u504f\u79fb\u6307\u9488"),(0,f.kt)("li",{parentName:"ul"},"ring_buffer_per_cpu->reader_page\u4e2d\u8fd8\u5305\u542b\u4e86\u4e00\u4e2a\u72ec\u7acb\u7684page\uff0c\u7528\u6765\u652f\u6301reader\u65b9\u5f0f\u7684\u8bfb\u64cd\u4f5c")),(0,f.kt)("h1",{id:"\u4e8cftrace\u7684\u5185\u6838\u6ce8\u518c"},"\u4e8c\uff0cftrace\u7684\u5185\u6838\u6ce8\u518c"),(0,f.kt)("p",null,"\u5bf9\u4e8eftrace\u7684framwork\u5c42\uff0c\u9996\u5148\u9700\u8981\u5efa\u7acb",(0,f.kt)("a",{parentName:"p",href:"https://zhida.zhihu.com/search?content_id=194763848&content_type=Article&match_order=1&q=debugfs&zd_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJ6aGlkYV9zZXJ2ZXIiLCJleHAiOjE3NDMxNzExNzIsInEiOiJkZWJ1Z2ZzIiwiemhpZGFfc291cmNlIjoiZW50aXR5IiwiY29udGVudF9pZCI6MTk0NzYzODQ4LCJjb250ZW50X3R5cGUiOiJBcnRpY2xlIiwibWF0Y2hfb3JkZXIiOjEsInpkX3Rva2VuIjpudWxsfQ.nyedhLi7L2sXKuYcPcqErb8Ep6UHWhZNLTjNRZJ6vUI&zhida_source=entity"},"debugfs"),"\u7684\u4e00\u7cfb\u5217\u7684\u8bbf\u95ee\u8282\u70b9\uff0c\u662f\u901a\u8fc7\u5982\u4e0b\u7684\u6d41\u7a0b\u5b8c\u6210\u7684"),(0,f.kt)("p",null,(0,f.kt)("img",{alt:"v2-8ad55885a702197e0b66196e0d039edf_r",src:r(33930).Z,width:"1190",height:"643"})),(0,f.kt)("p",null,"\u5b8c\u6210\u4e86\u6838\u5fc3\u7684\u6ce8\u518c\u540e\uff0c\u6211\u4eec\u6765\u770b\u770bftrace\u662f\u5982\u4f55\u5b8c\u6210\u5404\u4e2a\u529f\u80fd\u7684\uff0c\u5bf9\u4e8e\u4efb\u4f55\u4e00\u4e2atrace\u529f\u80fd\uff0c",(0,f.kt)("strong",{parentName:"p"},"\u90fd\u53ef\u4ee5\u5f52\u7eb3\u4e8e\u5982\u4e0b\u6d41\u7a0b\uff1a")),(0,f.kt)("ul",null,(0,f.kt)("li",{parentName:"ul"},"\u51fd\u6570\u63d2\u6869\uff1a \u4f7f\u7528\u5404\u79cd\u63d2\u6869\u65b9\u5f0f\u628a\u81ea\u5df1\u7684trace\u51fd\u6570\u63d2\u5165\u5230\u9700\u8981\u8ddf\u8e2a\u7684probe point\u4e0a"),(0,f.kt)("li",{parentName:"ul"},"Input trace\u6570\u636e\uff1a \u5728trace\u7684probe\u51fd\u6570\u4e2d\u547d\u4e2d\u65f6\uff0c\u4f1a\u5b58\u50a8\u6570\u636e\u5230ring buffer\u5f53\u4e2d\uff0c\u8fd9\u91cc\u4e3b\u8981\u5305\u62ecfilter\u548ctigger\u529f\u80fd"),(0,f.kt)("li",{parentName:"ul"},"Output trace\u6570\u636e\uff1a \u7528\u6237\u548c\u7a0b\u5e8f\u9700\u8981\u8bfb\u53d6trace\u6570\u636e\uff0c\u6839\u636e\u9700\u8981\u8f93\u51fa\u6570\u636e\uff0c\u5bf9\u6570\u636e\u8fdb\u884c\u89e3\u6790\u7b49")),(0,f.kt)("h2",{id:"21-function-tracer\u7684\u5b9e\u73b0"},"2.1 Function tracer\u7684\u5b9e\u73b0"),(0,f.kt)("p",null,'\u8fd9\u4e2a\u529f\u80fd\u662f\u5229\u7528_mcount()\u51fd\u6570\u8fdb\u884c\u63d2\u6869\u7684\uff0c\u5728gcc\u4f7f\u7528\u4e86"-gp\u201c\u9009\u9879\u4ee5\u540e\uff0c\u4f1a\u5728\u6bcf\u4e2a\u51fd\u6570\u5165\u53e3\u63d2\u5165\u4ee5\u4e0b\u7684\u8bed\u53e5'),(0,f.kt)("p",null,(0,f.kt)("img",{alt:"v2-437619132779b3504d125ef972c90451_1440w",src:r(14573).Z,width:"943",height:"438"})),(0,f.kt)("p",null,"\u6bcf\u4e2a\u51fd\u6570\u5165\u53e3\u5904\u63d2\u5165\u5bf9_mcount()\u51fd\u6570\u7684\u8c03\u7528\uff0c\u5c31\u662fgcc\u63d0\u4f9b\u7684\u63d2\u6869\u673a\u5236\uff0c\u6211\u4eec\u53ef\u4ee5\u91cd\u65b0\u5b9a\u4e49_mcount()\u51fd\u6570\u4e2d\u7684\u5185\u5bb9\uff0c\u8c03\u7528\u60f3\u8981\u6267\u884c\u7684\u5185\u5bb9\u3002\u5bf9\u4e8etracer\u81ea\u8eab\u800c\u8a00\uff0c\u662f\u4e0d\u662f\u9700\u8981-pg\u9009\u9879\uff0c\u56e0\u6b64\u5728kernel/tracing/Makefile\u4e2d\u5c06-pg\u9009\u9879\u4e2d\u7531\u6211\u4eec\u81ea\u5df1\u5b9a\u4e49"),(0,f.kt)("p",null,(0,f.kt)("img",{alt:"v2-2cab18882895033fa62d93c9b77af728_1440w",src:r(2596).Z,width:"890",height:"345"})),(0,f.kt)("h3",{id:"211-\u9759\u6001\u63d2\u6869"},"2.1.1 \u9759\u6001\u63d2\u6869"),(0,f.kt)("p",null,"\u6211\u4eec\u6765\u770b\u770bARM64\u5982\u4f55\u5904\u7406\u7684\uff0c\u5176\u4ee3\u7801\u8def\u5f84\u4e3aarch/arm64/kernel/entry-ftrace.S"),(0,f.kt)("p",null,(0,f.kt)("img",{alt:"v2-c1216c3a204eff9e28a66b48500c6437_r",src:r(83326).Z,width:"987",height:"686"})),(0,f.kt)("p",null,(0,f.kt)("strong",{parentName:"p"},"\u5f53\u672a\u9009\u4e2dCONFIG_DYNAMIC_FTRACE\u65f6\uff0c\u5176\u91c7\u7528\u5982\u4e0b\u7684\u65b9\u6848;")),(0,f.kt)("ul",null,(0,f.kt)("li",{parentName:"ul"},"\u6bcf\u4e2a\u51fd\u6570\u8c03\u7528\u90fd\u4f1a\u6839\u636e\u4e0d\u540c\u7684\u4f53\u7cfb\u7ed3\u6784\u7684\u5b9e\u73b0\u8c03\u7528_mcount\u51fd\u6570"),(0,f.kt)("li",{parentName:"ul"},"\u5982\u679cftrace\u4f7f\u7528\u4e86\u67d0\u4e9b\u8ddf\u8e2a\u5668\uff0cftrace_trace_function\u6307\u9488\u4e0d\u518d\u6307\u5411ftrace_stub\uff0c\u800c\u662f\u6307\u5411\u5177\u4f53\u7684\u8ddf\u8e2a\u51fd\u6570"),(0,f.kt)("li",{parentName:"ul"},"\u5426\u5219\u5c31\u6267\u884c\u5230\u4f53\u7cfb\u7ed3\u6784\u76f8\u5173\u7684ftrace_stub\u4ece\u51fd\u6570\u8fd4\u56de\uff0c\u800c\u8be5\u63a5\u53e3\u4e3a\u7a7a\u51fd\u6570")),(0,f.kt)("p",null,(0,f.kt)("img",{alt:"v2-aa88732557ae827f51d2717f3af624dc_r",src:r(42528).Z,width:"676",height:"70"})),(0,f.kt)("h3",{id:"212-\u52a8\u6001\u63d2\u6869"},"2.1.2 \u52a8\u6001\u63d2\u6869"),(0,f.kt)("p",null,"static ftrace\u4e00\u65e6\u4f7f\u80fd\uff0c\u5bf9kernel\u4e2d\u6240\u6709\u7684\u51fd\u6570(\u9664\u5f00notrace\u3001online\u3001\u5176\u4ed6\u7279\u6b8a\u51fd\u6570)\u8fdb\u884c\u63d2\u88c5\uff0c\u8fd9\u5e26\u6765\u7684\u6027\u80fd\u5f00\u9500\u662f\u60ca\u4eba\u7684\uff0c\u6709\u53ef\u80fd\u5bfc\u81f4\u4eba\u4eec\u5f03\u7528ftrace\u529f\u80fd\u3002"),(0,f.kt)("p",null,'\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u5185\u6838\u5f00\u53d1\u8005\u63a8\u51fa\u4e86dynamic ftrace\uff0c\u56e0\u4e3a\u5b9e\u9645\u4e0a\u8c03\u7528\u8005\u4e00\u822c\u4e0d\u9700\u8981\u5bf9\u6240\u6709\u51fd\u6570\u8fdb\u884c\u8ffd\u8e2a\uff0c\u53ea\u4f1a\u5bf9\u611f\u5174\u8da3\u7684\u4e00\u90e8\u5206\u51fd\u6570\u8fdb\u884c\u8ffd\u8e2a\u3002dynamic ftrace\u628a\u4e0d\u9700\u8981\u8ffd\u8e2a\u7684\u51fd\u6570\u5165\u53e3\u5904\u6307\u4ee4\u201cbl _mcount"\u66ff\u6362\u6210nop\uff0c\u8fd9\u6837\u57fa\u672c\u4e0a\u5bf9\u6027\u80fd\u65e0\u5f71\u54cd\uff0c\u5bf9\u9700\u8981\u8ffd\u8e2a\u7684\u51fd\u6570\u66ff\u6362\u5165\u53e3\u5904"bl _mcount"\u4e3a\u9700\u8981\u8c03\u7528\u7684\u51fd\u6570\u3002'),(0,f.kt)("ul",null,(0,f.kt)("li",{parentName:"ul"},"ftrace\u5728\u521d\u59cb\u5316\u65f6\uff0c\u201cscripts/recordmcount.pl\u201d\u811a\u672c\u8bb0\u5f55\u7684\u6240\u6709\u51fd\u6570\u5165\u53e3\u5904\u63d2\u6869\u4f4d\u7f6e\u7684\u201cbl _mcount\u201d\uff0c\u5c06\u5176\u66ff\u6362\u6210\u201cnop\u201d\u6307\u4ee4\uff0c\u5bf9\u6027\u80fd\u57fa\u672c\u65e0\u5f71\u54cd"),(0,f.kt)("li",{parentName:"ul"},"\u5728tracer enable\u7684\u65f6\u5019\uff0c\u628a\u9700\u8981\u8ddf\u8e2a\u7684\u51fd\u6570\u7684\u63d2\u6869\u4f4d\u7f6enop\u66ff\u6362\u6210bl ftrace_caller")),(0,f.kt)("p",null,(0,f.kt)("img",{alt:"v2-ff24f390f26d41862312f89549c356ed_r",src:r(11341).Z,width:"825",height:"660"})),(0,f.kt)("p",null,"\u5728\u7f16\u8bd1\u7684\u65f6\u5019\u8c03\u7528recordmcount.pl\u641c\u7d22\u6240\u6709_mcount\u51fd\u6570\u8c03\u7528\u70b9\uff0c\u5e76\u4e14\u6240\u6709\u7684\u8c03\u7528\u70b9\u5730\u5740\u4fdd\u5b58\u5230section _mcount_loc\uff0c\u5176\u5b9a\u4e49\u5728include/asm-generic/vmlinux.lds.h\uff0c\u8be6\u7ec6\u7684\u89c1\u6587\u4ef6\u4ee5\u5177\u4f53\u7814\u7a76\u201cscripts/recordmcount.pl\u3001scripts/recordmcount.c\u201d\u3002"),(0,f.kt)("p",null,(0,f.kt)("img",{alt:"v2-273bbb42eb4c4a2738b943b3229384d5_r",src:r(52711).Z,width:"774",height:"280"})),(0,f.kt)("p",null,"\u5728\u521d\u59cb\u5316\u65f6\uff0c\u904d\u5386section __mcount_loc\u7684\u8c03\u7528\u70b9\u5730\u5740\uff0c\u9ed8\u8ba4\u4e3a\u6240\u6709\u201cbl _mcount\u201d\u66ff\u6362\u6210\u201cnop\u201d\uff0c\u5176\u5b9a\u4e49\u4e3akernel/trace/ftrace.c"),(0,f.kt)("p",null,(0,f.kt)("img",{alt:"v2-26c700e0ed80688c007040f77ca70966_r",src:r(7626).Z,width:"797",height:"483"})),(0,f.kt)("h3",{id:"213-irqs-offpreempt-offpreempt-irqsoff-tracer"},"2.1.3 irqs off/preempt off/preempt irqsoff tracer"),(0,f.kt)("ul",null,(0,f.kt)("li",{parentName:"ul"},"irqsoff tracer\uff1a \u5f53\u4e2d\u65ad\u88ab\u7981\u6b62\u65f6\uff0c\u7cfb\u7edf\u65e0\u6cd5\u54cd\u5e94\u5916\u90e8\u4e8b\u4ef6\uff0c\u6bd4\u5982\u9f20\u6807\u548c\u952e\u76d8\uff0c\u65f6\u949f\u4e5f\u65e0\u6cd5\u4ea7\u751ftick\u4e2d\u65ad\uff0c\u8fd9\u4e5f\u610f\u5473\u7740\u7cfb\u7edf\u54cd\u5e94\u5ef6\u8fdf\uff0cirqsoff\u8fd9\u4e2atracer\u80fd\u591f\u8ddf\u8e2a\u5e76\u8bb0\u5f55\u5185\u6838\u4e2d\u54ea\u4e9b\u51fd\u6570\u7981\u6b62\u4e86\u4e2d\u65ad\uff0c\u5bf9\u4e8e\u5176\u4e2d\u4e2d\u65ad\u7981\u6b62\u65f6\u95f4\u6700\u957f\u7684\uff0cirqsoff\u5c06\u5728Log\u6587\u4ef6\u4e2d\u7b2c\u4e00\u884c\u6807\u8bb0\u51fa\u6765\uff0c\u4ece\u800c\u4f7f\u5f00\u53d1\u8005\u53ef\u4ee5\u8fc5\u901f\u5b9a\u4f4d\u9020\u6210\u54cd\u5e94\u5ef6\u8fdf\u7684\u7f6a\u9b41\u7978\u9996"),(0,f.kt)("li",{parentName:"ul"},"preemptoff tracer\uff1a \u8ddf\u8e2a\u5e76\u8bb0\u5f55\u7981\u6b62\u5185\u6838\u62a2\u5360\u5e76\u5173\u95ed\u4e2d\u65ad\u5360\u7528\u671f\u95f4\u7684\u51fd\u6570\uff0c\u5e76\u6e05\u6670\u5730\u663e\u793a\u51fa\u7981\u6b62\u62a2\u5360\u65f6\u95f4\u6700\u957f\u7684\u5185\u6838\u51fd\u6570"),(0,f.kt)("li",{parentName:"ul"},"preempt irqsoff tracer: \u8ddf\u8e2a\u548c\u8bb0\u5f55\u7981\u6b62\u4e2d\u65ad\u6216\u7981\u6b62\u62a2\u5360\u7684\u5185\u6838\u51fd\u6570\uff0c\u4ee5\u53ca\u7981\u6b62\u65f6\u95f4\u6700\u957f\u7684\u51fd\u6570")),(0,f.kt)("p",null,(0,f.kt)("strong",{parentName:"p"},"preemptoff\u4e0eirqsoff\u8ddf\u8e2a\u5668")),(0,f.kt)("p",null,"preempt off\u4e0eirqs off\u8ddf\u8e2a\u5668\u7528\u7684\u8ddf\u8e2a\u51fd\u6570\u662f\u76f8\u540c\u7684\uff0c\u90fd\u662firqsoff_tracer_call()\u3002"),(0,f.kt)("p",null,"preemptoff\u4e0eirqsoff\u8ddf\u8e2a\u5668\u7684\u4e0d\u540c\u4e4b\u5904"),(0,f.kt)("p",null,"irqsoff\u8ddf\u8e2a\u5668\u7684start\u70b9\u5728\u5f00\u542f\u6216\u5173\u95ed\u4e2d\u65ad\u7684\u5730\u65b9\uff0c\u5982local_irq_disable()"),(0,f.kt)("p",null,"preemptoff\u8ddf\u8e2a\u5668\u7684start\u70b9\u5728\u5f00\u542f\u6216\u5173\u95ed\u62a2\u5360\u7684\u5730\u65b9\uff0c\u5982prempt_disable()"),(0,f.kt)("p",null,(0,f.kt)("img",{alt:"v2-17e3fd0528caf09b71ce07f85d1b03d3_r",src:r(16112).Z,width:"708",height:"183"})),(0,f.kt)("p",null,"irqsoff tracer\u7684\u63d2\u6869\u65b9\u6cd5\uff0c\u662f\u76f4\u63a5\u5728local_irq_enable()\u3001local_irq_disable()\u4e2d\u76f4\u63a5\u63d2\u5165\u94a9\u5b50\u51fd\u6570trace_hardirqs_on()\u3001trace_hardirqs_off()\u3002"),(0,f.kt)("p",null,(0,f.kt)("img",{alt:"v2-c504cb01a770d6a6cfc4cf4d6b9a0472_r",src:r(24096).Z,width:"1177",height:"306"})),(0,f.kt)("p",null,"\u6211\u4eec\u6765\u770b\u770bstart_critical_timing\u7684\u5b9e\u73b0\uff0c\u5176\u4e3b\u8981\u4e3a\uff1a"),(0,f.kt)("p",null,(0,f.kt)("img",{alt:"v2-fb7ec502cb0230944d8b69881adf6c68_r",src:r(81790).Z,width:"1024",height:"598"})),(0,f.kt)("p",null,"\u5176\u4e3b\u8981\u7684\u8bbe\u8ba1\u601d\u60f3\u5982\u4e0b"),(0,f.kt)("p",null,(0,f.kt)("img",{alt:"v2-53da13949b09a2c35d6132954532a26e_r",src:r(76730).Z,width:"1401",height:"391"})),(0,f.kt)("h2",{id:"22-trace-event"},"2.2 trace event"),(0,f.kt)("p",null,"linux trace\u4e2d\uff0c\u6700\u57fa\u7840\u7684\u65f6function tracer\u548ctracer event\uff0c\u4e0a\u9762\u5b66\u4e60\u4e86function\uff0c\u672c\u8282\u662f\u5b66\u4e60event\uff0c\u5176\u4e5f\u79bb\u4e0d\u5f00\u5982\u4e0b\u6d41\u7a0b"),(0,f.kt)("p",null,(0,f.kt)("img",{alt:"v2-b639d0d23c8ca3a00a9d3c4514b5ba49_r",src:r(91885).Z,width:"1004",height:"525"})),(0,f.kt)("p",null,"trace event\u7684\u63d2\u6869\u4f7f\u7528\u7684\u662f",(0,f.kt)("a",{parentName:"p",href:"https://zhida.zhihu.com/search?content_id=194763848&content_type=Article&match_order=1&q=tracepoint&zd_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJ6aGlkYV9zZXJ2ZXIiLCJleHAiOjE3NDMxNzExNzIsInEiOiJ0cmFjZXBvaW50IiwiemhpZGFfc291cmNlIjoiZW50aXR5IiwiY29udGVudF9pZCI6MTk0NzYzODQ4LCJjb250ZW50X3R5cGUiOiJBcnRpY2xlIiwibWF0Y2hfb3JkZXIiOjEsInpkX3Rva2VuIjpudWxsfQ.h_Isu7mAqNcwOWVjtiyUI4_Jd8DmgwyMWqlwWyXwqlk&zhida_source=entity"},"tracepoint"),"\u673a\u5236\uff0c\u8be5\u673a\u5236\u662f\u4e00\u79cd\u9759\u6001\u7684\u63d2\u6869\u65b9\u6cd5\uff0c\u5b83\u9700\u8981\u9759\u6001\u7684\u5b9a\u4e49\u6869\u51fd\u6570\uff0c\u5e76\u4e14\u5728\u63d2\u6869\u4f4d\u7f6e\u663e\u5f0f\u8c03\u7528\u3002\u8fd9\u79cd\u65b9\u6cd5\u7684\u597d\u5904\u662f\u9ad8\u6548\u53ef\u9760\uff0c\u5e76\u4e14\u53ef\u4ee5\u5904\u4e8e\u51fd\u6570\u4e2d\u7684\u4efb\u4f55\u4f4d\u7f6e\u3001\u65b9\u4fbf\u7684\u8bbf\u95ee\u5404\u79cd\u53d8\u91cf\uff0c\u574f\u5904\u662f\u4e0d\u592a\u7075\u6d3b\u3002\u5bf9\u4e8ekernel\u5728\u91cd\u8981\u7684\u8282\u70b9\u56fa\u5b9a\u4f4d\u7f6e\uff0c\u63d2\u5165\u4e86\u51e0\u767e\u4e2atrace event\u7528\u4e8e\u8ddf\u8e2a\u3002"),(0,f.kt)("p",null,(0,f.kt)("img",{alt:"v2-793d4aec6243b543241e78c515121e0b_r",src:r(95040).Z,width:"1371",height:"594"})),(0,f.kt)("p",null,"\u5bf9\u4e8e\u5185\u6838\uff0c\u6211\u4eec\u521b\u5efa\u4e86\u51e0\u4e2a\u64cd\u4f5ctracepoint\u7684\u51fd\u6570:"),(0,f.kt)("ul",null,(0,f.kt)("li",{parentName:"ul"},"\u6869\u51fd\u6570\uff1a trace_##name();"),(0,f.kt)("li",{parentName:"ul"},"\u6ce8\u518c\u56de\u8c03\u51fd\u6570\uff1a register",(0,f.kt)("em",{parentName:"li"},"trace"),"##name();"),(0,f.kt)("li",{parentName:"ul"},"\u6ce8\u9500\u56de\u8c03\u51fd\u6570\uff1aunregister",(0,f.kt)("em",{parentName:"li"},"trace"),"##name();")),(0,f.kt)("p",null,"tracepoint \u7684\u5b9a\u4e49\u5982\u4e0b\uff1a"),(0,f.kt)("pre",null,(0,f.kt)("code",{parentName:"pre"},"struct tracepoint {\n    const char *name;       /* Tracepoint name */\n    struct static_key key;\n    void (*regfunc)(void);\n    void (*unregfunc)(void);\n    struct tracepoint_func __rcu *funcs;\n};\n")),(0,f.kt)("ul",null,(0,f.kt)("li",{parentName:"ul"},"key tracepoint:\u662f\u5426\u4f7f\u80fd\u5f00\u5173\uff0c\u5982\u679c\u56de\u8c03\u51fd\u6570\u6570\u7ec4\u4e3a\u7a7a\uff0c\u5219key\u4e3adisable\uff1b\u5982\u679c\u56de\u8c03\u51fd\u6570\u6570\u7ec4\u4e2d\u6709\u51fd\u6570\u6307\u9488\uff0c\u5219key\u4e3aenable"),(0,f.kt)("li",{parentName:"ul"},"regfunc/unregfunc: \u6ce8\u518c/\u6ce8\u9500\u56de\u8c03\u51fd\u6570\u65f6\u7684\u94a9\u5b50\u51fd\u6570"),(0,f.kt)("li",{parentName:"ul"},"funcs :\u56de\u8c03\u51fd\u6570\u6570\u7ec4\uff0ctracepoint\u7684\u4f5c\u7528\u5c31\u662f\u5728\u6869\u51fd\u6570\u88ab\u547d\u4e2d\u65f6\uff0c\u9010\u4e2a\u8c03\u7528\u56de\u8c03\u51fd\u6570\u6570\u7ec4\u7684\u51fd\u6570")),(0,f.kt)("p",null,"\u6211\u4eec\u5728\u63a2\u6d4b\u70b9\u63d2\u5165\u6869\u51fd\u6570\uff1a(kernl/sched/core.c)"),(0,f.kt)("pre",null,(0,f.kt)("code",{parentName:"pre"},"static void __sched notrace __schedule(bool preempt)\n{\n    ...\n    trace_sched_switch(preempt, prev, next);\n    ...\n}\n")),(0,f.kt)("p",null,"\u6869\u51fd\u6570\u88ab\u547d\u4e2d\u65f6\u7684\u6267\u884c\u6d41\u7a0b\uff0c\u53ef\u4ee5\u770b\u5230\u5c31\u662f\u9010\u4e2a\u7684\u6267\u884c\u56de\u8c03\u51fd\u6570\u6570\u7ec4\u4e2d\u7684\u51fd\u6570\u6307\u9488:"),(0,f.kt)("p",null,(0,f.kt)("img",{alt:"v2-67e2d3fcb3f948b07d74b1817983ad2a_r",src:r(88401).Z,width:"1116",height:"237"})),(0,f.kt)("p",null,(0,f.kt)("img",{alt:"v2-d89a370a5cac042dabd81b4f02a1c452_r",src:r(69695).Z,width:"1136",height:"362"})),(0,f.kt)("p",null,"\u53ef\u4ee5\u901a\u8fc7 register",(0,f.kt)("em",{parentName:"p"},"trace"),"##name()/unregister",(0,f.kt)("em",{parentName:"p"},"trace"),"##name() \u51fd\u6570\u5411\u56de\u8c03\u51fd\u6570\u6570\u7ec4\u4e2d\u6dfb\u52a0/\u5220\u9664\u51fd\u6570\u6307\u9488"),(0,f.kt)("p",null,(0,f.kt)("img",{alt:"v2-3f7ea42857f084418e15d04474472ef3_r",src:r(65494).Z,width:"1118",height:"324"})),(0,f.kt)("p",null,"trace event \u5bf9 tracepoint \u7684\u5229\u7528\uff0c\u4ee5\u4e0a\u53ef\u4ee5\u770b\u5230\uff0ctracepoint \u53ea\u662f\u4e00\u79cd\u9759\u6001\u63d2\u6869\u65b9\u6cd5\u3002trace event \u53ef\u4ee5\u4f7f\u7528\uff0c\u5176\u4ed6\u673a\u5236\u4e5f\u53ef\u4ee5\u4f7f\u7528\uff0c\u53ea\u662f kernel \u7684\u7edd\u5927\u90e8\u5206 tracepoint \u90fd\u662f trace event \u5728\u4f7f\u7528\u3002"),(0,f.kt)("p",null,"trace event \u4e5f\u5fc5\u987b\u5411 tracepoint \u6ce8\u518c\u81ea\u5df1\u7684\u56de\u8c03\u51fd\u6570\uff0c\u8fd9\u4e9b\u56de\u8c03\u51fd\u6570\u7684\u4f5c\u7528\u5c31\u662f\u5728\u51fd\u6570\u88ab\u547d\u4e2d\u65f6\u5f80 ringbuffer \u4e2d\u5199\u5165 trace \u4fe1\u606f\u3002ftrace\u5f00\u53d1\u8005\u4eec\u610f\u8bc6\u5230\u4e86\u8fd9\u70b9\uff0c\u6240\u4ee5\u63d0\u4f9b\u4e86trace event\u529f\u80fd\uff0c\u5f00\u53d1\u8005\u4e0d\u9700\u8981\u81ea\u5df1\u53bb\u6ce8\u518c\u6869\u51fd\u6570\u4e86\uff0c\u6613\u7528\u6027\u8f83\u597d"),(0,f.kt)("h3",{id:"221-\u589e\u52a0\u4e00\u4e2a\u65b0\u7684-trace-event"},"2.2.1 \u589e\u52a0\u4e00\u4e2a\u65b0\u7684 trace event"),(0,f.kt)("p",null,"\u5728\u73b0\u6709\u7684\u4ee3\u7801\u4e2d\u6dfb\u52a0\u63a2\u6d4b\u51fd\u6570\uff0c\u8fd9\u662f\u8ba9\u5f88\u591a\u5185\u6838\u5f00\u53d1\u8005\u975e\u5e38\u4e0d\u723d\u7684\u4e00\u4ef6\u4e8b\uff0c\u56e0\u4e3a\u8fd9\u53ef\u80fd\u964d\u4f4e\u6027\u80fd\u6216\u8005\u8ba9\u4ee3\u7801\u770b\u8d77\u6765\u975e\u5e38\u81c3\u80bf\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e9b\u95ee\u9898\uff0c\u5185\u6838\u6700\u7ec8\u8fdb\u5316\u51fa\u4e86\u4e00\u4e2a TRACE_EVENT() \u6765\u5b9e\u73b0 trace event \u7684\u5b9a\u4e49\uff0c\u8fd9\u662f\u975e\u5e38\u7b80\u6d01\u3001\u667a\u80fd\u7684\u4e00\u4e2a\u5b8f\u5b9a\u4e49\u3002"),(0,f.kt)("p",null,"\u9996\u5148\u6211\u4eec\u5148\u6765\u4e86\u89e3\u4e00\u4e0b\u600e\u4e48\u6837\u4f7f\u7528 TRACE_EVENT() \u65b0\u589e\u52a0\u4e00\u4e2a trace event\uff0c\u65b0\u589e\u52a0 trace event\uff0c\u6211\u4eec\u5fc5\u987b\u9075\u5faa\u89c4\u5b9a\u7684\u683c\u5f0f\u3002"),(0,f.kt)("p",null,"\u4ee5\u4e0b\u4ee5\u5185\u6838\u4e2d\u5df2\u7ecf\u5b58\u5728\u7684 event sched_switch \u4e3a\u4f8b\uff0c\u8bf4\u660e\u5b9a\u4e49\u8fc7\u7a0b\u3002"),(0,f.kt)("p",null,"\u9996\u5148\u9700\u8981\u5728 include/trace/events/\u6587\u4ef6\u5939\u4e0b\u6dfb\u52a0\u4e00\u4e2a\u81ea\u5df1 event \u7684\u5934\u6587\u4ef6\uff0c\u9700\u8981\u9075\u5faa\u6ce8\u91ca\u7684\u6807\u51c6\u683c\u5f0f\uff1ainclude/trace/events/sched.h"),(0,f.kt)("p",null,"\u5728\u63a2\u6d4b\u70b9\u4f4d\u7f6e\u4e2d\u8c03\u7528\u6869\u51fd\u6570\uff0c\u9700\u8981\u9075\u5faa\u6ce8\u91ca\u7684\u6807\u51c6\u683c\u5f0f"),(0,f.kt)("p",null,"\u7531\u4e8e\u5185\u6838\u5404\u4e2a\u5b50\u7cfb\u7edf\u5927\u91cf\u4f7f\u7528 event tracing \u6765 trace \u4e0d\u540c\u7684\u4e8b\u4ef6\uff0c\u6bcf\u6709\u4e00\u4e2a\u9700\u8981 trace \u7684\u4e8b\u4ef6\u5c31\u5b9e\u73b0\u8fd9\u4e48\u4e00\u5957\u51fd\u6570\uff0c\u8fd9\u6837\u5185\u6838\u5c31\u4f1a\u5b58\u5728\u5927\u91cf\u7c7b\u4f3c\u7684\u91cd\u590d\u7684\u4ee3\u7801\uff0c\u4e3a\u4e86\u907f\u514d\u8fd9\u6837\u7684\u60c5\u51b5\uff0c\u5185\u6838\u5f00\u53d1\u8005\u4f7f\u7528\u4e00\u4e2a\u5b8f\uff0c\u8ba9\u5b8f\u81ea\u52a8\u5c55\u5f00\u6210\u5177\u6709\u76f8\u4f3c\u6027\u7684\u4ee3\u7801\u3002\u8fd9\u4e2a\u5b8f\u5c31\u662f TRACE_EVENT\uff0c\u8981\u4e3a\u67d0\u4e2a\u4e8b\u4ef6\u6dfb\u52a0\u4e00\u4e2a trace event\uff0c\u53ea\u9700\u8981\u58f0\u660e\u8fd9\u6837\u4e00\u4e2a\u5b8f\u5c31\u53ef\u4ee5\u4e86"),(0,f.kt)("h1",{id:"\u4e09kprobe"},"\u4e09\u3001kprobe"),(0,f.kt)("p",null,"kprobe event\u5c31\u662f\u8fd9\u6837\u7684\u4ea7\u7269\u3002krpobe event\u548ctrace event\u7684\u529f\u80fd\u4e00\u6837\uff0c\u4f46\u662f\u56e0\u4e3a\u5b83\u91c7\u7528\u7684\u662fkprobe\u63d2\u6869\u673a\u5236\uff0c\u6240\u4ee5\u5b83\u4e0d\u9700\u8981\u9884\u7559\u63d2\u6869\u4f4d\u7f6e\uff0c\u53ef\u4ee5\u52a8\u6001\u7684\u5728\u4efb\u4f55\u4f4d\u7f6e\u8fdb\u884c\u63d2\u6869\u3002\u5f00\u9500\u4f1a\u5927\u4e00\u70b9\uff0c\u4f46\u662f\u975e\u5e38\u7075\u6d3b\uff0c\u662f\u4e00\u4e2a\u975e\u5e38\u65b9\u4fbf\u7684\u8865\u5145\u673a\u5236\u3002"),(0,f.kt)("p",null,"kprobe\u7684\u4e3b\u8981\u539f\u7406\u662f\u4f7f\u7528\u201c\u65ad\u70b9\u5f02\u5e38\u201d\u548c\u201c\u5355\u6b65\u5f02\u5e38\u201d\u4e24\u79cd\u5f02\u5e38\u6307\u4ee4\u6765\u5bf9\u4efb\u610f\u5730\u5740\u8fdb\u884c\u63d2\u6869\uff0c\u5728\u6b64\u57fa\u7840\u4e4b\u4e0a\u5b9e\u73b0\u4e86\u4e09\u79cd\u673a\u5236\uff1a"),(0,f.kt)("ul",null,(0,f.kt)("li",{parentName:"ul"},"kprobe\uff1a \u53ef\u4ee5\u88ab\u63d2\u5165\u5230\u5185\u6838\u7684\u4efb\u4f55\u6307\u4ee4\u4f4d\u7f6e\uff0c\u5728\u88ab\u63d2\u5165\u6307\u4ee4\u4e4b\u524d\u8c03\u7528kp.pre_handler()\uff0c\u5728\u88ab\u63d2\u5165\u6307\u4ee4\u4e4b\u540e\u8c03\u7528kp.post_handler()"),(0,f.kt)("li",{parentName:"ul"},"jprobe\uff1a \u53ea\u652f\u6301\u5bf9\u51fd\u6570\u8fdb\u884c\u63d2\u5165"),(0,f.kt)("li",{parentName:"ul"},"kretprobe\uff1a \u548cjprobe\u7c7b\u4f3c\uff0c\u673a\u5236\u7565\u6709\u4e0d\u540c\uff0c\u4f1a\u66ff\u6362\u88ab\u63a2\u6d4b\u51fd\u6570\u7684\u8fd4\u56de\u5730\u5740\uff0c\u8ba9\u51fd\u6570\u5148\u6267\u884c\u63d2\u5165\u7684\u94a9\u5b50\u51fd\u6570\uff0c\u518d\u6062\u590d\u3002")))}b.isMDXComponent=!0},37540:function(e,t,r){t.Z=r.p+"assets/images/image-20250326225000375-91504b981890792a1d42413d69c91c83.png"},16112:function(e,t,r){t.Z=r.p+"assets/images/v2-17e3fd0528caf09b71ce07f85d1b03d3_r-7ce2e3e8518707f220a7c7748e24f886.jpg"},7626:function(e,t,r){t.Z=r.p+"assets/images/v2-26c700e0ed80688c007040f77ca70966_r-912ef0ca078bc9d05c544059f6205550.jpg"},52711:function(e,t,r){t.Z=r.p+"assets/images/v2-273bbb42eb4c4a2738b943b3229384d5_r-7f7ca1092b86d2a035c4c29392b11016.jpg"},2596:function(e,t,r){t.Z=r.p+"assets/images/v2-2cab18882895033fa62d93c9b77af728_1440w-bc555d32b488bfb602d361fb6532d0b7.jpg"},65494:function(e,t,r){t.Z=r.p+"assets/images/v2-3f7ea42857f084418e15d04474472ef3_r-36ec04ac3f677fb3c82ba052c595e7e1.jpg"},14573:function(e,t,r){t.Z=r.p+"assets/images/v2-437619132779b3504d125ef972c90451_1440w-c4aa184012a14ae1b0d15f4ee6e5e254.jpg"},76730:function(e,t,r){t.Z=r.p+"assets/images/v2-53da13949b09a2c35d6132954532a26e_r-010c2233dbd8ff12d44f8e70216ab8b7.jpg"},88401:function(e,t,r){t.Z=r.p+"assets/images/v2-67e2d3fcb3f948b07d74b1817983ad2a_r-d322aa406c7ecffd9387eb11337b9b9b.jpg"},95040:function(e,t,r){t.Z=r.p+"assets/images/v2-793d4aec6243b543241e78c515121e0b_r-76813db121b99f3b9ff7d0fce7b9352a.jpg"},33930:function(e,t,r){t.Z=r.p+"assets/images/v2-8ad55885a702197e0b66196e0d039edf_r-ef4e961fec83c2e61d52d61dcdb0367f.jpg"},42528:function(e,t){t.Z="data:image/jpeg;base64,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"},91885:function(e,t,r){t.Z=r.p+"assets/images/v2-b639d0d23c8ca3a00a9d3c4514b5ba49_r-8ee56d42596e7fd587ac0bfa2bc068a3.jpg"},83326:function(e,t,r){t.Z=r.p+"assets/images/v2-c1216c3a204eff9e28a66b48500c6437_r-b1fcecf220279a09d5972806aa3a9916.jpg"},24096:function(e,t,r){t.Z=r.p+"assets/images/v2-c504cb01a770d6a6cfc4cf4d6b9a0472_r-ae9f7db49f83b01d55a4414eee5af299.jpg"},69695:function(e,t,r){t.Z=r.p+"assets/images/v2-d89a370a5cac042dabd81b4f02a1c452_r-ed01cf4dcbf4800321ea6adf003aca1f.jpg"},81790:function(e,t,r){t.Z=r.p+"assets/images/v2-fb7ec502cb0230944d8b69881adf6c68_r-4dd95170ded7be114ef7ff565bea066c.jpg"},11341:function(e,t,r){t.Z=r.p+"assets/images/v2-ff24f390f26d41862312f89549c356ed_r-c8aa374bf6b3b3420649adc2e00b29a3.jpg"}}]);