"use strict";(self.webpackChunkshaozongfan_website=self.webpackChunkshaozongfan_website||[]).push([[37352],{3905:function(n,e,t){t.d(e,{Zo:function(){return c},kt:function(){return x}});var r=t(67294);function i(n,e,t){return e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function a(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,r)}return t}function l(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?a(Object(t),!0).forEach((function(e){i(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}function p(n,e){if(null==n)return{};var t,r,i=function(n,e){if(null==n)return{};var t,r,i={},a=Object.keys(n);for(r=0;r<a.length;r++)t=a[r],e.indexOf(t)>=0||(i[t]=n[t]);return i}(n,e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(n);for(r=0;r<a.length;r++)t=a[r],e.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(n,t)&&(i[t]=n[t])}return i}var o=r.createContext({}),u=function(n){var e=r.useContext(o),t=e;return n&&(t="function"==typeof n?n(e):l(l({},e),n)),t},c=function(n){var e=u(n.components);return r.createElement(o.Provider,{value:e},n.children)},s={inlineCode:"code",wrapper:function(n){var e=n.children;return r.createElement(r.Fragment,{},e)}},_=r.forwardRef((function(n,e){var t=n.components,i=n.mdxType,a=n.originalType,o=n.parentName,c=p(n,["components","mdxType","originalType","parentName"]),_=u(t),x=i,f=_["".concat(o,".").concat(x)]||_[x]||s[x]||a;return t?r.createElement(f,l(l({ref:e},c),{},{components:t})):r.createElement(f,l({ref:e},c))}));function x(n,e){var t=arguments,i=e&&e.mdxType;if("string"==typeof n||i){var a=t.length,l=new Array(a);l[0]=_;var p={};for(var o in e)hasOwnProperty.call(e,o)&&(p[o]=e[o]);p.originalType=n,p.mdxType="string"==typeof n?n:i,l[1]=p;for(var u=2;u<a;u++)l[u]=t[u];return r.createElement.apply(null,l)}return r.createElement.apply(null,t)}_.displayName="MDXCreateElement"},71793:function(n,e,t){t.r(e),t.d(e,{assets:function(){return c},contentTitle:function(){return o},default:function(){return x},frontMatter:function(){return p},metadata:function(){return u},toc:function(){return s}});var r=t(87462),i=t(63366),a=(t(67294),t(3905)),l=["components"],p={},o=void 0,u={permalink:"/blog/\u6280\u672f\u535a\u5ba2/\u5d4c\u5165\u5f0f/linux\u8bbe\u5907\u9a71\u52a8\u5f00\u53d1\u8be6\u89e3/14.6\u3000\u6570\u636e\u63a5\u6536\u6d41\u7a0b",editUrl:"https://github.com/shaozongfan/shaozongfan.github.io/blog/\u6280\u672f\u535a\u5ba2/\u5d4c\u5165\u5f0f/linux\u8bbe\u5907\u9a71\u52a8\u5f00\u53d1\u8be6\u89e3/14.6\u3000\u6570\u636e\u63a5\u6536\u6d41\u7a0b.md",source:"@site/blog/\u6280\u672f\u535a\u5ba2/\u5d4c\u5165\u5f0f/linux\u8bbe\u5907\u9a71\u52a8\u5f00\u53d1\u8be6\u89e3/14.6\u3000\u6570\u636e\u63a5\u6536\u6d41\u7a0b.md",title:"\u6280\u672f\u535a\u5ba2/\u5d4c\u5165\u5f0f/linux\u8bbe\u5907\u9a71\u52a8\u5f00\u53d1\u8be6\u89e3/14.6\u3000\u6570\u636e\u63a5\u6536\u6d41\u7a0b",description:"\u7f51\u7edc\u8bbe\u5907\u63a5\u6536\u6570\u636e\u7684\u4e3b\u8981\u65b9\u6cd5\u662f\u7531\u4e2d\u65ad\u5f15\u53d1\u8bbe\u5907\u7684\u4e2d\u65ad\u5904\u7406\u51fd\u6570\uff0c\u4e2d\u65ad\u5904\u7406\u51fd\u6570\u5224\u65ad\u4e2d\u65ad\u7c7b\u578b\uff0c\u5982\u679c\u4e3a\u63a5\u6536\u4e2d\u65ad\uff0c\u5219\u8bfb\u53d6\u63a5\u6536\u5230\u7684\u6570\u636e\uff0c\u5206\u914dskbuffer\u6570\u636e\u7ed3\u6784\u548c\u6570\u636e\u7f13\u51b2\u533a\uff0c\u5c06\u63a5\u6536\u5230\u7684\u6570\u636e\u590d\u5236\u5230\u6570\u636e\u7f13\u51b2\u533a\uff0c\u5e76\u8c03\u7528netifrx\uff08\uff09\u51fd\u6570\u5c06sk_buffer\u4f20\u9012\u7ed9\u4e0a\u5c42\u534f\u8bae\u3002\u4ee3\u7801\u6e05\u535514.9\u6240\u793a\u4e3a\u5b8c\u6210\u8fd9\u4e2a\u8fc7\u7a0b\u7684\u51fd\u6570\u6a21\u677f\u3002",date:"2025-09-15T14:44:14.221Z",formattedDate:"2025\u5e749\u670815\u65e5",tags:[],readingTime:6.495,truncated:!1,authors:[],frontMatter:{},prevItem:{title:"\u6280\u672f\u535a\u5ba2/\u5d4c\u5165\u5f0f/linux\u8bbe\u5907\u9a71\u52a8\u5f00\u53d1\u8be6\u89e3/18.3\u3000\u7531\u8bbe\u5907\u6811\u5f15\u53d1\u7684BSP\u548c\u9a71\u52a8\u53d8\u66f4",permalink:"/blog/\u6280\u672f\u535a\u5ba2/\u5d4c\u5165\u5f0f/linux\u8bbe\u5907\u9a71\u52a8\u5f00\u53d1\u8be6\u89e3/18.3\u3000\u7531\u8bbe\u5907\u6811\u5f15\u53d1\u7684BSP\u548c\u9a71\u52a8\u53d8\u66f4"},nextItem:{title:"\u6280\u672f\u535a\u5ba2/\u5d4c\u5165\u5f0f/linux\u8bbe\u5907\u9a71\u52a8\u5f00\u53d1\u8be6\u89e3/21.4\u3000DEBUG_LL\u548cEARLY_PRINTK",permalink:"/blog/\u6280\u672f\u535a\u5ba2/\u5d4c\u5165\u5f0f/linux\u8bbe\u5907\u9a71\u52a8\u5f00\u53d1\u8be6\u89e3/21.4\u3000DEBUG_LL\u548cEARLY_PRINTK"}},c={authorsImageUrls:[]},s=[],_={toc:s};function x(n){var e=n.components,p=(0,i.Z)(n,l);return(0,a.kt)("wrapper",(0,r.Z)({},_,p,{components:e,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"\u7f51\u7edc\u8bbe\u5907\u63a5\u6536\u6570\u636e\u7684\u4e3b\u8981\u65b9\u6cd5\u662f\u7531\u4e2d\u65ad\u5f15\u53d1\u8bbe\u5907\u7684\u4e2d\u65ad\u5904\u7406\u51fd\u6570\uff0c\u4e2d\u65ad\u5904\u7406\u51fd\u6570\u5224\u65ad\u4e2d\u65ad\u7c7b\u578b\uff0c\u5982\u679c\u4e3a\u63a5\u6536\u4e2d\u65ad\uff0c\u5219\u8bfb\u53d6\u63a5\u6536\u5230\u7684\u6570\u636e\uff0c\u5206\u914dsk_buffer\u6570\u636e\u7ed3\u6784\u548c\u6570\u636e\u7f13\u51b2\u533a\uff0c\u5c06\u63a5\u6536\u5230\u7684\u6570\u636e\u590d\u5236\u5230\u6570\u636e\u7f13\u51b2\u533a\uff0c\u5e76\u8c03\u7528netif_rx\uff08\uff09\u51fd\u6570\u5c06sk_buffer\u4f20\u9012\u7ed9\u4e0a\u5c42\u534f\u8bae\u3002\u4ee3\u7801\u6e05\u535514.9\u6240\u793a\u4e3a\u5b8c\u6210\u8fd9\u4e2a\u8fc7\u7a0b\u7684\u51fd\u6570\u6a21\u677f\u3002"),(0,a.kt)("p",null,"\u4ee3\u7801\u6e05\u535514.9\u3000\u7f51\u7edc\u8bbe\u5907\u9a71\u52a8\u7684\u4e2d\u65ad\u5904\u7406\u51fd\u6570\u6a21\u677f"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"}," 1static void xxx_interrupt(int irq, void *dev_id)\n 2{\n 3  ...\n 4  switch (status &ISQ_EVENT_MASK) {\n 5  case ISQ_RECEIVER_EVENT:\n 6      /* \u83b7\u53d6\u6570\u636e\u5305*/\n 7      xxx_rx(dev);\n 8      break;\n 9      /* \u5176\u4ed6\u7c7b\u578b\u7684\u4e2d\u65ad*/\n10  }\n11}\n12static void xxx_rx(struct xxx_device *dev)\n13{\n14  ...\n15  length = get_rev_len (...);\n16  /* \u5206\u914d\u65b0\u7684\u5957\u63a5\u5b57\u7f13\u51b2\u533a*/\n17  skb = dev_alloc_skb(length + 2);\n18\n19  skb_reserve(skb, 2); /* \u5bf9\u9f50*/\n20  skb->dev = dev;\n21\n22  /* \u8bfb\u53d6\u786c\u4ef6\u4e0a\u63a5\u6536\u5230\u7684\u6570\u636e*/\n23  insw(ioaddr + RX_FRAME_PORT, skb_put(skb, length), length >> 1);\n24  if (length &1)\n25    skb->data[length - 1] = inw(ioaddr + RX_FRAME_PORT);\n26\n27  /* \u83b7\u53d6\u4e0a\u5c42\u534f\u8bae\u7c7b\u578b*/\n28  skb->protocol = eth_type_trans(skb, dev);\n29\n30  /* \u628a\u6570\u636e\u5305\u4ea4\u7ed9\u4e0a\u5c42*/\n31  netif_rx(skb);\n32\n33  /* \u8bb0\u5f55\u63a5\u6536\u65f6\u95f4\u6233*/\n34  dev->last_rx = jiffies;\n35  ...\n36}\n")),(0,a.kt)("p",null,"\u4ece\u4e0a\u8ff0\u4ee3\u7801\u7684\u7b2c4~7\u884c\u53ef\u4ee5\u770b\u51fa\uff0c\u5f53\u8bbe\u5907\u7684\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\u5224\u65ad\u4e2d\u65ad\u7c7b\u578b\u4e3a\u6570\u636e\u5305\u63a5\u6536\u4e2d\u65ad\u65f6\uff0c\u5b83\u8c03\u7528\u7b2c12~36\u884c\u5b9a\u4e49\u7684xxx_rx\uff08\uff09\u51fd\u6570\u5b8c\u6210\u66f4\u6df1\u5165\u7684\u6570\u636e\u5305\u63a5\u6536\u5de5\u4f5c\u3002xxx_rx\uff08\uff09\u51fd\u6570\u4ee3\u7801\u4e2d\u7684\u7b2c15\u884c\u4ece\u786c\u4ef6\u8bfb\u53d6\u5230\u63a5\u6536\u6570\u636e\u5305\u6709\u6548\u6570\u636e\u7684\u957f\u5ea6\uff0c\u7b2c16~19\u884c\u5206\u914dsk_buff\u548c\u6570\u636e\u7f13\u51b2\u533a\uff0c\u7b2c22~25\u884c\u8bfb\u53d6\u786c\u4ef6\u4e0a\u63a5\u6536\u5230\u7684\u6570\u636e\u5e76\u653e\u5165\u6570\u636e\u7f13\u51b2\u533a\uff0c\u7b2c27~28\u884c\u89e3\u6790\u63a5\u6536\u6570\u636e\u5305\u4e0a\u5c42\u534f\u8bae\u7684\u7c7b\u578b\uff0c\u6700\u540e\uff0c\u7b2c30~31\u884c\u4ee3\u7801\u5c06\u6570\u636e\u5305\u4e0a\u4ea4\u7ed9\u4e0a\u5c42\u534f\u8bae\u3002"),(0,a.kt)("p",null,"\u5982\u679c\u662fNAPI\u517c\u5bb9\u7684\u8bbe\u5907\u9a71\u52a8\uff0c\u5219\u53ef\u4ee5\u901a\u8fc7poll\u65b9\u5f0f\u63a5\u6536\u6570\u636e\u5305\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u9700\u8981\u4e3a\u8be5\u8bbe\u5907\u9a71\u52a8\u63d0\u4f9b\u4f5c\u4e3anetif_napi_add\uff08\uff09\u53c2\u6570\u7684xxx_poll\uff08\uff09\u51fd\u6570\uff0c\u5982\u4ee3\u7801\u6e05\u535514.10\u6240\u793a\u3002"),(0,a.kt)("p",null,"\u4ee3\u7801\u6e05\u535514.10\u3000\u7f51\u7edc\u8bbe\u5907\u9a71\u52a8\u7684xxx_poll\uff08\uff09\u51fd\u6570\u6a21\u677f"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"}," 1static int xxx_poll(struct napi_struct *napi, int budget)\n 2{\n 3  int npackets = 0;\n 4  struct sk_buff *skb;\n 5  struct xxx_priv *priv = container_of(napi, struct xxx_priv, napi);\n 6  struct xxx_packet *pkt;\n 7\n 8  while (npackets < budget && priv->rx_queue) {\n 9    /* \u4ece\u961f\u5217\u4e2d\u53d6\u51fa\u6570\u636e\u5305*/\n10    pkt = xxx_dequeue_buf(dev);\n11\n12    /* \u63a5\u4e0b\u6765\u7684\u5904\u7406\u548c\u4e2d\u65ad\u89e6\u53d1\u7684\u6570\u636e\u5305\u63a5\u6536\u4e00\u81f4*/\n13    skb = dev_alloc_skb(pkt->datalen + 2);\n14    ...\n15    skb_reserve(skb, 2);\n16    memcpy(skb_put(skb, pkt->datalen), pkt->data, pkt->datalen);\n17    skb->dev = dev;\n18    skb->protocol = eth_type_trans(skb, dev);\n19    /* \u8c03\u7528netif_receive_skb\uff0c\u800c\u4e0d\u662fnet_rx, \u5c06\u6570\u636e\u5305\u4ea4\u7ed9\u4e0a\u5c42\u534f\u8bae*/\n20    netif_receive_skb(skb);\n21\n22    /* \u66f4\u6539\u7edf\u8ba1\u6570\u636e*/\n23    priv->stats.rx_packets++;\n24    priv->stats.rx_bytes += pkt->datalen;\n25    xxx_release_buffer(pkt);\n26    npackets++;\n27  }\n28  if (npackets < budget) {\n29      napi_complete(napi);\n30      xxx_enable_rx_int (\u2026); /* \u518d\u6b21\u542f\u52a8\u7f51\u7edc\u8bbe\u5907\u7684\u63a5\u6536\u4e2d\u65ad*/\n31  }\n32  return npackets;\n33}\n")),(0,a.kt)("p",null,"\u4e0a\u8ff0\u4ee3\u7801\u4e2d\u7684budget\u662f\u5728\u521d\u59cb\u5316\u9636\u6bb5\u5206\u914d\u7ed9\u63a5\u53e3\u7684weight\u503c\uff0cxxx_poll\uff08\uff09\u51fd\u6570\u6bcf\u6b21\u53ea\u80fd\u63a5\u6536\u6700\u591abudget\u4e2a\u6570\u636e\u5305\u3002\u7b2c8\u884c\u7684while\uff08\uff09\u5faa\u73af\u8bfb\u53d6\u8bbe\u5907\u7684\u63a5\u6536\u7f13\u51b2\u533a\uff0c\u540c\u65f6\u8bfb\u53d6\u6570\u636e\u5305\u5e76\u63d0\u4ea4\u7ed9\u4e0a\u5c42\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u548c\u4e2d\u65ad\u89e6\u53d1\u7684\u6570\u636e\u5305\u63a5\u6536\u8fc7\u7a0b\u4e00\u81f4\uff0c\u4f46\u662f\u6700\u540e\u4f7f\u7528\u7684\u662fnetif_receive_skb\uff08\uff09\u51fd\u6570\u800c\u4e0d\u662fnetif_rx\uff08\uff09\u51fd\u6570\u5c06\u6570\u636e\u5305\u63d0\u4ea4\u7ed9\u4e0a\u5c42\u3002\u8fd9\u91cc\u4f53\u73b0\u51fa\u4e86\u4e2d\u65ad\u5904\u7406\u673a\u5236\u548c\u8f6e\u8be2\u673a\u5236\u4e4b\u95f4\u7684\u5dee\u522b\u3002"),(0,a.kt)("p",null,"\u5f53\u4e00\u4e2a\u8f6e\u8be2\u8fc7\u7a0b\u7ed3\u675f\u65f6\uff0c\u7b2c29\u884c\u4ee3\u7801\u8c03\u7528napi_complete\uff08\uff09\u5ba3\u5e03\u8fd9\u4e00\u6d88\u606f\uff0c\u800c\u7b2c30\u884c\u4ee3\u7801\u5219\u518d\u6b21\u542f\u52a8\u7f51\u7edc\u8bbe\u5907\u7684\u63a5\u6536\u4e2d\u65ad\u3002"),(0,a.kt)("p",null,"\u867d\u7136NAPI\u517c\u5bb9\u7684\u8bbe\u5907\u9a71\u52a8\u4ee5xxx_poll\uff08\uff09\u65b9\u5f0f\u63a5\u6536\u6570\u636e\u5305\uff0c\u4f46\u662f\u4ecd\u7136\u9700\u8981\u9996\u6b21\u6570\u636e\u5305\u63a5\u6536\u4e2d\u65ad\u6765\u89e6\u53d1\u8fd9\u4e2a\u8fc7\u7a0b\u3002\u4e0e\u6570\u636e\u5305\u7684\u4e2d\u65ad\u63a5\u6536\u65b9\u5f0f\u4e0d\u540c\u7684\u662f\uff0c\u4ee5\u8f6e\u8be2\u65b9\u5f0f\u63a5\u6536\u6570\u636e\u5305\u65f6\uff0c\u5f53\u7b2c\u4e00\u6b21\u4e2d\u65ad\u53d1\u751f\u540e\uff0c\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\u8981\u7981\u6b62\u8bbe\u5907\u7684\u6570\u636e\u5305\u63a5\u6536\u4e2d\u65ad\u5e76\u8c03\u5ea6NAPI\uff0c\u5982\u4ee3\u7801\u6e05\u535514.11\u6240\u793a\u3002"),(0,a.kt)("p",null,"\u4ee3\u7801\u6e05\u535514.11\u3000\u7f51\u7edc\u8bbe\u5907\u9a71\u52a8\u7684poll\u4e2d\u65ad\u5904\u7406"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"}," 1static void xxx_interrupt(int irq, void *dev_id)\n 2{\n 3  switch (status &ISQ_EVENT_MASK) {\n 4  case ISQ_RECEIVER_EVENT:\n 5      \u2026 /* \u83b7\u53d6\u6570\u636e\u5305*/\n 6      xxx_disable_rx_int(...);  /* \u7981\u6b62\u63a5\u6536\u4e2d\u65ad*/\n 7      napi_schedule(&priv->napi);\n 8      break;\n 9    \u2026 /* \u5176\u4ed6\u7c7b\u578b\u7684\u4e2d\u65ad*/\n10  }\n11}\n")),(0,a.kt)("p",null,"\u4e0a\u8ff0\u4ee3\u7801\u7b2c7\u884c\u7684napi_schedule\uff08\uff09\u51fd\u6570\u88ab\u8f6e\u8be2\u65b9\u5f0f\u9a71\u52a8\u7684\u4e2d\u65ad\u7a0b\u5e8f\u8c03\u7528\uff0c\u5c06\u8bbe\u5907\u7684poll\u65b9\u6cd5\u6dfb\u52a0\u5230\u7f51\u7edc\u5c42\u7684poll\u5904\u7406\u961f\u5217\u4e2d\uff0c\u6392\u961f\u5e76\u4e14\u51c6\u5907\u63a5\u6536\u6570\u636e\u5305\uff0c\u6700\u7ec8\u89e6\u53d1\u4e00\u4e2aNET_RX_SOFTIRQ\u8f6f\u4e2d\u65ad\uff0c\u4ece\u800c\u901a\u77e5\u7f51\u7edc\u5c42\u63a5\u6536\u6570\u636e\u5305\u3002\u56fe14.3\u6240\u793a\u4e3aNAPI\u9a71\u52a8\u7a0b\u5e8f\u5404\u90e8\u5206\u7684\u8c03\u7528\u5173\u7cfb\u3002"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"1744902006741",src:t(99583).Z,width:"978",height:"427"})),(0,a.kt)("p",null,"\u56fe14.3\u3000NAPI\u9a71\u52a8\u7a0b\u5e8f\u5404\u90e8\u5206\u7684\u8c03\u7528\u5173\u7cfb"),(0,a.kt)("p",null,"\u5728\u652f\u6301NAPI\u7684\u7f51\u7edc\u8bbe\u5907\u9a71\u52a8\u4e2d\uff0c\u901a\u5e38\u8fd8\u4f1a\u8fdb\u884c\u5982\u4e0b\u4e0eNAPI\u76f8\u5173\u7684\u5de5\u4f5c\u3002"),(0,a.kt)("p",null,"1\uff09\u5728\u79c1\u6709\u6570\u636e\u7ed3\u6784\u4f53\uff08\u5982xxx_priv\uff09\u4e2d\u589e\u52a0\u4e00\u4e2a\u6210\u5458\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"struct napi_struct napi;\n")),(0,a.kt)("p",null,"\u5728\u4ee3\u7801\u4e2d\u5c31\u53ef\u4ee5\u65b9\u4fbf\u5730\u4f7f\u7528container_of\uff08\uff09\u901a\u8fc7NAPI\u6210\u5458\u53cd\u5411\u83b7\u5f97\u5bf9\u5e94\u7684xxx_priv\u6307\u9488\u3002"),(0,a.kt)("p",null,"2\uff09\u901a\u5e38\u4f1a\u5728\u8bbe\u5907\u9a71\u52a8\u521d\u59cb\u5316\u65f6\u8c03\u7528\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"netif_napi_add(dev, napi, xxx_poll, XXX_NET_NAPI_WEIGHT);\n")),(0,a.kt)("p",null,"3\uff09\u901a\u5e38\u4f1a\u5728net_device\u7ed3\u6784\u4f53\u7684open\uff08\uff09\u548cstop\uff08\uff09\u6210\u5458\u51fd\u6570\u4e2d\u5206\u522b\u8c03\u7528napi_enable\uff08\uff09\u548cnapi_disable\uff08\uff09\u3002"))}x.isMDXComponent=!0},99583:function(n,e,t){e.Z=t.p+"assets/images/1744902006741-c5b83eecc6bb858c56dc51f801b8d813.png"}}]);